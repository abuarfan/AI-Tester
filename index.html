<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Token Limit Tester</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100vh;
            overflow: hidden; /* Prevent body scroll */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .container {
            max-width: 100%;
            height: 100vh;
            margin: 0;
            background: rgba(255, 255, 255, 0.98);
            display: flex;
            flex-direction: column;
        }

        /* Header Compact */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            text-align: center;
            flex-shrink: 0;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header h1 {
            font-size: 1.4em;
            margin: 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .header p {
            opacity: 0.9;
            font-size: 0.85em;
            margin: 0;
        }

        /* Main Layout - 3 Columns Fit Screen */
        .main-content {
            display: grid;
            grid-template-columns: 280px 1fr 280px;
            gap: 0;
            flex: 1;
            overflow: hidden; /* Prevent overflow */
            height: calc(100vh - 60px); /* Minus header */
        }

        /* Sidebar Kiri - Scrollable tapi compact */
        .sidebar-left {
            background: #f8f9fa;
            padding: 15px;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Sidebar Kanan - Scrollable tapi compact */
        .sidebar-right {
            background: #f8f9fa;
            padding: 15px;
            border-left: 1px solid #e0e0e0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Tengah - Fixed height, no scroll on container */
        .chat-center {
            padding: 15px;
            display: flex;
            flex-direction: column;
            background: #ffffff;
            overflow: hidden;
            gap: 10px;
        }

        /* Section Titles Compact */
        .section-title {
            font-size: 0.95em;
            color: #333;
            margin-bottom: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }

        /* Input Groups Compact */
        .input-group {
            margin-bottom: 8px;
        }

        .input-group label {
            display: block;
            margin-bottom: 4px;
            color: #555;
            font-weight: 500;
            font-size: 0.8em;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.85em;
            height: 32px;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .api-key-input {
            position: relative;
        }

        .toggle-visibility {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 0.9em;
        }

        /* Model Info Compact */
        .model-info {
            background: #e3f2fd;
            padding: 8px;
            border-radius: 6px;
            font-size: 0.75em;
            color: #1565c0;
            border-left: 3px solid #2196f3;
            line-height: 1.4;
            margin-top: 5px;
        }

        /* Token Stats Compact - Vertical layout */
        .token-stats {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px;
            border-radius: 8px;
            flex-shrink: 0;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 0.8em;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: rgba(255,255,255,0.9);
        }

        .stat-value {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        /* Token Visualizer Compact */
        .token-visualizer {
            background: white;
            padding: 8px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .token-visualizer > div:first-child {
            font-size: 0.8em;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .token-bar {
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .token-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.7em;
            font-weight: bold;
            transition: width 0.3s;
        }

        .limit-warning {
            color: #ff9800;
            font-size: 0.7em;
            margin-top: 3px;
        }

        /* History Compact */
        #historyList {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .history-item {
            background: white;
            padding: 8px;
            border-radius: 6px;
            border-left: 3px solid #667eea;
            cursor: pointer;
            font-size: 0.75em;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .history-timestamp {
            font-size: 0.75em;
            color: #999;
            margin-bottom: 2px;
        }

        .history-preview {
            color: #555;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Chat Center Layout */
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
            flex-shrink: 0;
        }

        .chat-header h2 {
            font-size: 1.1em;
            margin: 0;
            color: #333;
        }

        /* Message Boxes - Fixed height ratio */
        .message-box {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .message-header {
            background: #f8f9fa;
            padding: 6px 12px;
            font-size: 0.8em;
            font-weight: 600;
            color: #555;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
            flex-shrink: 0;
        }

        /* Input Box - 35% height */
        .input-box {
            height: 35%;
            border-color: #667eea;
        }

        /* Output Box - 45% height */
        .output-box {
            height: 45%;
            border-color: #764ba2;
        }

        .message-content {
            flex: 1;
            padding: 10px;
            display: flex;
        }

        .message-content textarea {
            width: 100%;
            height: 100%;
            border: none;
            resize: none;
            font-family: inherit;
            font-size: 0.9em;
            line-height: 1.5;
            outline: none;
        }

        .response-area {
            flex: 1;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            line-height: 1.5;
            overflow-y: auto;
            background: #fafafa;
            white-space: pre-wrap;
        }

        .btn {
            padding: 8px 20px;
            border: none;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* Loading - Overlay style */
        .loading {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            text-align: center;
            z-index: 100;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notification System */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }

        .toast {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            animation: slideIn 0.3s ease, fadeOut 0.3s ease 4.7s;
            transform-origin: top right;
            position: relative;
            overflow: hidden;
            min-width: 300px;
        }

        .toast::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
        }

        .toast-success {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.95) 0%, rgba(69, 160, 73, 0.95) 100%);
            color: white;
        }

        .toast-success::before {
            background: #2e7d32;
        }

        .toast-error {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.95) 0%, rgba(218, 25, 11, 0.95) 100%);
            color: white;
        }

        .toast-error::before {
            background: #b71c1c;
        }

        .toast-warning {
            background: linear-gradient(135deg, rgba(255, 152, 0, 0.95) 0%, rgba(245, 124, 0, 0.95) 100%);
            color: white;
        }

        .toast-warning::before {
            background: #e65100;
        }

        .toast-info {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.95) 0%, rgba(25, 118, 210, 0.95) 100%);
            color: white;
        }

        .toast-info::before {
            background: #0d47a1;
        }

        .toast-icon {
            font-size: 1.5em;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .toast-content {
            flex: 1;
            min-width: 0;
        }

        .toast-title {
            font-weight: 700;
            font-size: 0.95em;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toast-message {
            font-size: 0.85em;
            opacity: 0.95;
            line-height: 1.4;
        }

        .toast-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .toast-close:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: rgba(255,255,255,0.3);
        }

        .toast-progress-bar {
            height: 100%;
            background: rgba(255,255,255,0.8);
            animation: progress 5s linear;
            transform-origin: left;
        }

        /* Modal/Popup Confirmation System */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 16px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.3);
            max-width: 450px;
            width: 90%;
            transform: scale(0.8) translateY(20px);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
        }

        .modal-overlay.active .modal {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            padding: 24px 24px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            flex-shrink: 0;
        }

        .modal-icon.danger {
            background: #ffebee;
            color: #c62828;
        }

        .modal-icon.warning {
            background: #fff3e0;
            color: #ef6c00;
        }

        .modal-icon.info {
            background: #e3f2fd;
            color: #1565c0;
        }

        .modal-icon.success {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .modal-title {
            font-size: 1.25em;
            font-weight: 700;
            color: #333;
            margin: 0;
        }

        .modal-body {
            padding: 16px 24px 24px;
            color: #666;
            font-size: 0.95em;
            line-height: 1.6;
        }

        .modal-body strong {
            color: #333;
        }

        .modal-body ul {
            margin: 12px 0;
            padding-left: 20px;
        }

        .modal-body li {
            margin: 6px 0;
        }

        .modal-footer {
            padding: 0 24px 24px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .modal-btn-secondary {
            background: #f5f5f5;
            color: #666;
        }

        .modal-btn-secondary:hover {
            background: #e0e0e0;
        }

        .modal-btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
        }

        .modal-btn-danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(244, 67, 54, 0.4);
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .modal-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        /* Modal untuk mobile */
        @media (max-width: 480px) {
            .modal {
                width: 95%;
                margin: 20px;
            }
            
            .modal-header {
                padding: 20px 20px 0;
            }
            
            .modal-body {
                padding: 12px 20px 20px;
            }
            
            .modal-footer {
                padding: 0 20px 20px;
                flex-direction: column-reverse;
            }
            
            .modal-btn {
                width: 100%;
                justify-content: center;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%) scale(0.8);
                opacity: 0;
            }
            to {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
            to {
                opacity: 0;
                transform: translateX(100%) scale(0.8);
            }
        }

        @keyframes progress {
            from { transform: scaleX(1); }
            to { transform: scaleX(0); }
        }

        /* Toast untuk mobile */
        @media (max-width: 480px) {
            .toast-container {
                left: 10px;
                right: 10px;
                top: 10px;
                max-width: none;
            }
            
            .toast {
                min-width: auto;
            }
        }

        /* Tips Box Compact */
        .sidebar-right > div:last-child {
            background: #fff3e0;
            padding: 8px;
            border-radius: 6px;
            border-left: 3px solid #ff9800;
            font-size: 0.75em;
            flex-shrink: 0;
        }

        .button-group-center {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            height: 10%;
            flex-shrink: 0;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #555;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
            transform: translateY(-1px);
        }

        /* Scrollbar Minimalist */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        /* Responsive - Stack on small screens */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                overflow-y: auto;
            }
            
            .sidebar-left, .sidebar-right {
                border: none;
                border-bottom: 1px solid #e0e0e0;
                height: auto;
                max-height: 50vh;
            }
            
            .chat-center {
                min-height: 600px;
            }
        }

        /* Streaming Indicator */
        .streaming-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            color: #667eea;
            font-size: 0.85em;
            font-weight: 500;
        }

        .streaming-dots {
            display: flex;
            gap: 4px;
        }

        .streaming-dots span {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: bounce 1.4s ease-in-out infinite both;
        }

        .streaming-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .streaming-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        .streaming-text {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Cursor blinking untuk streaming text */
        .streaming-cursor {
            display: inline-block;
            width: 2px;
            height: 1em;
            background: #667eea;
            margin-left: 2px;
            animation: blink 1s step-end infinite;
            vertical-align: text-bottom;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        /* Samakan tinggi dan alignment */
        .btn-action {
            height: 44px;
            padding: 0 24px; /* vertical center dengan flex */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border-radius: 22px; /* pill shape */
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            white-space: nowrap;
        }

        /* Secondary - Teks Uji (Abu dengan border) */
        .btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .btn-secondary:hover {
            background: #e9ecef;
            border-color: #ced4da;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
        }

        /* Primary - Kirim (Gradient ungu) */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        /* Icon styling */
        .btn-action span {
            font-size: 1.1em;
            line-height: 1;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            margin-bottom: 10px;
            transition: all 0.3s;
            background: #fafafa;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #e8edff;
            transform: scale(1.02);
        }

        .upload-input {
            display: none;
        }

        .upload-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
            color: #555;
            transition: all 0.2s;
        }

        .upload-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .uploaded-files {
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .uploaded-file {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 10px;
            background: white;
            border-radius: 6px;
            font-size: 0.75em;
            border: 1px solid #e0e0e0;
        }

        .uploaded-file-info {
            display: flex;
            align-items: center;
            gap: 6px;
            overflow: hidden;
        }

        .uploaded-file-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }

        .uploaded-file-size {
            color: #888;
            font-size: 0.9em;
        }

        .uploaded-file-remove {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            padding: 2px;
            font-size: 1.1em;
            line-height: 1;
        }

        .uploaded-file-remove:hover {
            color: #f44336;
        }

        .file-content-preview {
            margin-top: 8px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            font-size: 0.7em;
            color: #666;
            max-height: 80px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            display: none;
        }

        .file-content-preview.show {
            display: block;
        }

        .file-content-preview::before {
            content: 'üìÑ Preview konten:';
            display: block;
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
        }

        /* Tombol Upload - format sama dengan yang lain */
        .btn-upload {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            color: #2e7d32;
            border: 2px solid #4caf50;
            position: relative;
            overflow: hidden;
        }

        .btn-upload:hover {
            background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
            color: white;
            border-color: #4caf50;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(76, 175, 80, 0.3);
        }

        .btn-upload.has-file {
            background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
            color: white;
            border-color: #4caf50;
            animation: pulse-green 2s infinite;
        }

        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(76, 175, 80, 0); }
        }

        /* Upload Info (file yang sudah diupload) */
        .upload-info {
            display: flex;
            justify-content: center;
            margin-top: 8px;
            animation: fadeIn 0.3s ease;
        }

        .upload-info-content {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: #e8f5e9;
            border-radius: 20px;
            font-size: 0.8em;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }

        .upload-info-remove {
            background: rgba(255,255,255,0.8);
            border: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
            color: #666;
            line-height: 1;
            padding: 0;
            margin-left: 4px;
        }

        .upload-info-remove:hover {
            background: #f44336;
            color: white;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Tombol Voice - format sama dengan yang lain */
        .btn-voice {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            color: #e65100;
            border: 2px solid #ff9800;
            position: relative;
            overflow: hidden;
        }

        .btn-voice:hover {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            border-color: #ff9800;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 152, 0, 0.3);
        }

        .btn-voice.recording {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            border-color: #f44336;
            animation: pulse-red 1.5s infinite;
        }

        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(244, 67, 54, 0); }
        }

        .btn-voice.recording span::before {
            content: '‚èπ';
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Voice status indicator */
        .voice-status {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 8px;
            padding: 8px 16px;
            background: #fff3e0;
            border-radius: 20px;
            font-size: 0.8em;
            color: #e65100;
            animation: fadeIn 0.3s ease;
        }

        .voice-status.active {
            display: flex;
        }

        .voice-wave {
            display: flex;
            gap: 3px;
            align-items: center;
            height: 20px;
        }

        .voice-wave span {
            width: 3px;
            background: #ff9800;
            border-radius: 2px;
            animation: wave 1s ease-in-out infinite;
        }

        .voice-wave span:nth-child(1) { animation-delay: 0s; height: 8px; }
        .voice-wave span:nth-child(2) { animation-delay: 0.1s; height: 16px; }
        .voice-wave span:nth-child(3) { animation-delay: 0.2s; height: 12px; }
        .voice-wave span:nth-child(4) { animation-delay: 0.3s; height: 20px; }
        .voice-wave span:nth-child(5) { animation-delay: 0.4s; height: 10px; }

        @keyframes wave {
            0%, 100% { transform: scaleY(0.5); }
            50% { transform: scaleY(1); }
        }

        /* Browser not supported */
        .voice-unsupported {
            display: none;
            font-size: 0.75em;
            color: #999;
            text-align: center;
            margin-top: 4px;
        }

        /* Audio Upload */
        .audio-upload {
            margin-top: 10px;
        }

        .audio-upload-area {
            border: 2px dashed #ff9800;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fff8e1;
        }

        .audio-upload-area:hover {
            background: #ffecb3;
            border-color: #f57c00;
        }

        .audio-upload-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: white;
            border: 1px solid #ff9800;
            border-radius: 6px;
            color: #e65100;
            font-size: 0.85em;
            font-weight: 500;
        }

        .audio-info {
            margin-top: 8px;
            display: flex;
            justify-content: center;
        }

        .audio-info-content {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #fff8e1;
            border-radius: 20px;
            font-size: 0.85em;
            color: #e65100;
            border: 1px solid #ffcc80;
        }

        .audio-remove {
            background: rgba(255,255,255,0.8);
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            color: #666;
            line-height: 1;
            padding: 0;
            margin-left: 4px;
        }

        .audio-remove:hover {
            background: #f44336;
            color: white;
        }

        /* Tombol Audio - format sama dengan yang lain */
        .btn-audio {
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%);
            color: #c2185b;
            border: 2px solid #e91e63;
            position: relative;
            overflow: hidden;
        }

        .btn-audio:hover {
            background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);
            color: white;
            border-color: #e91e63;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(233, 30, 99, 0.3);
        }

        .btn-audio.has-file {
            background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);
            color: white;
            border-color: #e91e63;
            animation: pulse-pink 2s infinite;
        }

        @keyframes pulse-pink {
            0%, 100% { box-shadow: 0 0 0 0 rgba(233, 30, 99, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(233, 30, 99, 0); }
        }

        /* Audio Output Controls */
        .audio-output-controls {
            display: flex; /* GANTI dari none ke flex */
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            padding: 8px 12px;
            background: #f5f5f5;
            border-radius: 20px;
            font-size: 0.8em;
            opacity: 0; /* Hidden tapi tetap ada di layout */
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .audio-output-controls.active {
            opacity: 1;
            visibility: visible;
        }

        .audio-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .audio-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .audio-btn.playing {
            animation: pulse-purple 1.5s infinite;
        }

        @keyframes pulse-purple {
            0%, 100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(102, 126, 234, 0); }
        }

        .audio-speed {
            display: flex;
            align-items: center;
            gap: 4px;
            background: white;
            padding: 4px 10px;
            border-radius: 12px;
            border: 1px solid #ddd;
        }

        .audio-speed select {
            border: none;
            background: none;
            font-size: 0.85em;
            color: #555;
            cursor: pointer;
            outline: none;
        }

        .audio-status {
            color: #666;
            font-size: 0.85em;
            margin-left: auto;
        }

        .audio-progress {
            flex: 1;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            min-width: 60px;
        }

        .audio-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.1s linear;
        }

    </style>
    <base target="_blank">
    <!-- PDF Parser -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- DOCX Parser -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ AI Token Limit Tester</h1>
            <p>Uji batas token dan limit rate berbagai model AI dalam satu aplikasi</p>
        </div>

        <div class="main-content">
            <!-- KOLOM KIRI: Settings -->
            <div class="sidebar-left">
                <div class="section-title" style="align-items: center; justify-content: center;">üîß PENGATURAN</div>
                
                <div class="input-group">
                    <label>PROVIDER</label>
                    <select id="providerSelect" onchange="switchProvider(this.value)">
                        <optgroup label="üü¢ FREE - No Credit Card">
                            <option value="gemini">Google Gemini</option>
                            <option value="groq">Groq</option>
                            <option value="cerebras">Cerebras</option>
                            <option value="mistral">Mistral AI</option>
                            <option value="openrouter">OpenRouter</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="sambanova">SambaNova</option>
                            <option value="ai21">AI21 Labs</option>
                            <option value="cloudflare">Cloudflare</option>
                            <option value="github">GitHub Models</option>
                            <option value="together">Together AI</option>
                            <option value="fireworks">Fireworks AI</option>
                            <option value="huggingface">Hugging Face</option>
                            <option value="siliconflow">SiliconFlow</option>
                            <option value="replicate">Replicate</option>
                            <option value="routeway">Routeway</option>
                        </optgroup>
                        <optgroup label="üí∞ PAID / Trial">
                            <option value="openai">OpenAI</option>
                            <option value="anthropic">Anthropic Claude</option>
                            <option value="cohere">Cohere</option>
                            <option value="perplexity">Perplexity</option>
                        </optgroup>
                    </select>
                </div>

                <div class="input-group">
                    <label>API KEY <span id="providerLabel">Gemini</span></label>
                    <div class="api-key-input">
                        <input type="password" id="apiKey" placeholder="API Key...">
                        <button class="toggle-visibility" onclick="toggleApiKey()">üëÅ</button>
                    </div>
                    <div style="margin-top: 4px; font-size: 0.75em;">
                        <a href="#" id="apiKeyLink" target="_blank" style="color: #667eea;">üîó Dapatkan API Key di sini</a>
                    </div>
                </div>

                <div class="input-group">
                    <label>MODEL AI</label>
                    <select id="modelSelect" onchange="updateModelInfo()"></select>
                </div>

                <div class="model-info" id="modelInfo">Pilih model...</div>

                <button class="btn btn-secondary" onclick="saveApiKey()" style="width: 100%; align-items: center; justify-content: center; margin-top: 5px;">
                    üíæ Simpan
                </button>

                <div style="margin-top: 10px; border-top: 1px solid #ddd; padding-top: 10px;">
                    <div style="font-size: 0.75em; color: #666; margin-bottom: 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                        üóëÔ∏è Hapus Data
                    </div>
                    <button class="btn btn-secondary" onclick="clearChatOnly()" style="width: 100%; margin-bottom: 6px; font-size: 0.75em; display: flex; align-items: center; justify-content: center; gap: 6px;">
                        <span>üí¨</span> Chat Saja
                    </button>
                    <button class="btn btn-secondary" onclick="clearHistoryOnly()" style="width: 100%; margin-bottom: 6px; font-size: 0.75em; display: flex; align-items: center; justify-content: center; gap: 6px;">
                        <span>üìú</span> Riwayat Chat
                    </button>
                    <button class="btn btn-secondary" onclick="clearStatsOnly()" style="width: 100%; margin-bottom: 6px; font-size: 0.75em; display: flex; align-items: center; justify-content: center; gap: 6px;">
                        <span>üìä</span> Statistik Model Ini
                    </button>
                    <button class="btn btn-secondary" onclick="clearAllData()" style="width: 100%; font-size: 0.75em; background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); color: #c62828; border: 1px solid #ef9a9a; display: flex; align-items: center; justify-content: center; gap: 6px;">
                        <span>‚ö†Ô∏è</span> Semua Data
                    </button>
                </div>
            </div>

            <!-- KOLOM TENGAH: Chat -->
            <div class="chat-center" style="position: relative;">
                                
                <div class="chat-header" style="align-items: center; justify-content: center">
                    <h2>üí¨ Chat With AI (to be tested)</h2>
                </div>

                <div class="message-box input-box">
                    <div class="message-header">
                        <span>üìù Input</span>
                        <span id="inputTokenCount" style="font-family: monospace; color: #666;">0</span>
                    </div>
                    <div class="message-content">
                        <textarea id="chatInput" placeholder="Ketik pesan..." oninput="updateTokenCount()"></textarea>
                    </div>
                </div>

                <div class="button-group-center">
                    <!-- Teks Uji -->
                    <button class="btn-action btn-secondary" onclick="loadTestText()" id="btnTeksUji">
                        <span>üìÑ</span>
                        <span>Teks Uji</span>
                    </button>
                    
                    <!-- Upload Doc -->
                    <input type="file" id="fileInput" style="display: none;" 
                        accept=".pdf,.doc,.docx,.txt,.md,.json,.csv" 
                        onchange="handleFileUpload(event)">
                    <button class="btn-action btn-upload" onclick="document.getElementById('fileInput').click()" id="btnUpload">
                        <span>üìé</span>
                        <span id="uploadBtnText">Upload</span>
                    </button>
                    
                    <!-- Voice -->
                    <button class="btn-action btn-voice" onclick="toggleVoiceInput()" id="btnVoice" title="Rekam suara">
                        <span>üé§</span>
                        <span id="voiceBtnText">Voice</span>
                    </button>
                    
                    <!-- Pilih Audio (khusus Whisper) -->
                    <input type="file" id="audioInput" style="display: none;" 
                        accept="audio/*" 
                        onchange="handleAudioUpload(event)">
                    <button class="btn-action btn-audio" onclick="document.getElementById('audioInput').click()" id="btnAudio" style="display: none;">
                        <span>üéµ</span>
                        <span id="audioBtnText">Pilih Audio</span>
                    </button>
                    
                    <!-- Kirim ke AI -->
                    <button class="btn-action btn-primary" onclick="sendMessage()" id="sendBtn">
                        <span>üöÄ</span>
                        <span>Kirim ke AI</span>
                    </button>
                </div>

                <!-- Voice Status (hidden untuk audio model) -->
                <div class="voice-status" id="voiceStatus">
                    <div class="voice-wave">
                        <span></span><span></span><span></span><span></span><span></span>
                    </div>
                    <span>Mendengarkan...</span>
                    <span id="voiceTranscript" style="font-style: italic; opacity: 0.8;"></span>
                </div>

                <!-- Audio Info (hanya untuk audio model) -->
                <div class="audio-info" id="audioInfo" style="display: none;">
                    <div class="audio-info-content">
                        <span>üéµ</span>
                        <span id="audioFileName">audio.mp3</span>
                        <span id="audioDuration">(0:00)</span>
                        <button onclick="removeAudioFile()" class="audio-remove" title="Hapus">√ó</button>
                    </div>
                </div>

                <!-- Upload Info (hidden untuk audio model) -->
                <div class="upload-info" id="uploadInfo" style="display: none;">
                    <div class="upload-info-content">
                        <span id="uploadInfoIcon">üìé</span>
                        <span id="uploadInfoText">file.pdf</span>
                        <button onclick="removeUploadedFile()" class="upload-info-remove" title="Hapus file">√ó</button>
                    </div>
                </div>

                <!-- Voice Status -->
                <div class="voice-status" id="voiceStatus">
                    <div class="voice-wave">
                        <span></span>
                        <span></span>
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <span>Mendengarkan...</span>
                    <span id="voiceTranscript" style="font-style: italic; opacity: 0.8;"></span>
                </div>

                <!-- Info File Upload -->
                <div class="upload-info" id="uploadInfo" style="display: none;">
                    <div class="upload-info-content">
                        <span id="uploadInfoIcon">üìé</span>
                        <span id="uploadInfoText">file.pdf</span>
                        <button onclick="removeUploadedFile()" class="upload-info-remove" title="Hapus file">√ó</button>
                    </div>
                </div>

                <!-- Browser not supported message -->
                <div class="voice-unsupported" id="voiceUnsupported">
                    ‚ö†Ô∏è Browser tidak mendukung voice input
                </div>

                <!-- Info File Upload (muncul di bawah tombol jika ada file) -->
                <div class="upload-info" id="uploadInfo" style="display: none;">
                    <div class="upload-info-content">
                        <span id="uploadInfoIcon">üìé</span>
                        <span id="uploadInfoText">file.pdf</span>
                        <button onclick="removeUploadedFile()" class="upload-info-remove" title="Hapus file">√ó</button>
                    </div>
                </div>

                <!-- Streaming Indicator -->

                <div class="message-box output-box">
                    <div class="message-header">
                        <span>ü§ñ Response</span>
                        <span id="responseTime" style="color: #666;"></span>
                    </div>
                    <div class="response-area" id="responseArea">
                        <span style="color: #999; font-style: italic;">Jawaban akan muncul di sini...</span>
                    </div>
                    
                    <!-- Audio Output Controls -->
                    <div class="audio-output-controls" id="audioControls">
                        <button class="audio-btn" onclick="toggleSpeech()" id="playBtn" title="Putar/Pause">
                            üîä
                        </button>
                        <button class="audio-btn" onclick="refreshTTS()" id="refreshBtn" title="Refresh (ambil text terbaru)" style="background: #4caf50;">
                            üîÑ
                        </button>
                        <div class="audio-progress">
                            <div class="audio-progress-bar" id="audioProgressBar"></div>
                        </div>
                        <div class="audio-speed">
                            <span>‚ö°</span>
                            <select id="speechRate" onchange="updateSpeechRate()">
                                <option value="0.5">0.5x</option>
                                <option value="0.75">0.75x</option>
                                <option value="1" selected>1x</option>
                                <option value="1.25">1.25x</option>
                                <option value="1.5">1.5x</option>
                                <option value="2">2x</option>
                            </select>
                        </div>
                        <span class="audio-status" id="audioStatus">Siap</span>
                    </div>
                </div>
            </div>

            <!-- KOLOM KANAN: Stats -->
            <div class="sidebar-right">
                <div class="section-title" style="align-items: center; justify-content: center;">üìä STATISTIK</div>
                
                <div class="token-stats">
                    <div class="stat-row"><span class="stat-label">Input:</span><span class="stat-value" id="inputTokens">0</span></div>
                    <div class="stat-row"><span class="stat-label">Output:</span><span class="stat-value" id="outputTokens">0</span></div>
                    <div class="stat-row"><span class="stat-label">Total:</span><span class="stat-value" id="totalTokens">0</span></div>
                    <div class="stat-row"><span class="stat-label">Biaya:</span><span class="stat-value" id="estCost">$0.00</span></div>
                    <div class="stat-row"><span class="stat-label">Limit:</span><span class="stat-value" id="rateLimit">-</span></div>
                </div>

                <div class="token-visualizer">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <span style="font-weight: 600; font-size: 0.85em;">üìä Context Usage (Prediction)</span>
                        <span id="contextFraction" style="font-size: 0.75em; color: #666;">0 / 0</span>
                    </div>
                    <div class="token-bar" id="tokenBarContainer" title="Hover untuk detail">
                        <div class="token-fill" id="tokenBar" style="width: 0%">0%</div>
                    </div>
                    <div class="limit-warning" id="limitWarning" style="display: none; font-size: 0.75em; margin-top: 4px;"></div>
                    <div style="margin-top: 6px; font-size: 0.7em; color: #888; display: flex; justify-content: space-between;">
                        <span>Model: <span id="contextModelName">-</span></span>
                        <span id="contextRemaining">Sisa: -</span>
                    </div>
                </div>

                <div class="section-title" style="margin-top: 10px; align-items: center; justify-content: center;">üìù RIWAYAT CHAT</div>
                <div id="historyList">
                    <p style="color: #999; font-size: 0.75em; text-align: center;">Kosong</p>
                </div>

                <div>
                    <div style="font-weight: 600; color: #e65100; margin-bottom: 3px;">üí° Tips</div>
                    <div style="color: #bf360c; line-height: 1.3;">Test panjang pesan untuk cek limit context window.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Model configurations
        const modelConfigs = {
            gemini: {
                name: 'Gemini',
                models: [
                    { id: 'gemini-2.5-pro-exp-03-25', name: 'Gemini 2.5 Pro', context: 1048576, inputPrice: 2.00, outputPrice: 12.00, rpm: 30, badge: 'free' },
                    { id: 'gemini-2.5-flash', name: 'Gemini 2.5 Flash', context: 1048576, inputPrice: 0.30, outputPrice: 2.50, rpm: 30, badge: 'free' },
                    { id: 'gemini-2.5-flash-lite', name: 'Gemini 2.5 Flash Lite', context: 1048576, inputPrice: 0.10, outputPrice: 0.40, rpm: 30, badge: 'free' },
                    { id: 'gemini-2.0-flash', name: 'Gemini 2.0 Flash', context: 1048576, inputPrice: 0.50, outputPrice: 3.00, rpm: 30, badge: 'free' },
                    { id: 'gemini-2.0-flash-lite', name: 'Gemini 2.0 Flash Lite', context: 1048576, inputPrice: 0.075, outputPrice: 0.30, rpm: 30, badge: 'free' },
                    { id: 'gemma-3', name: 'Gemma 3', context: 128000, inputPrice: 0, outputPrice: 0, rpm: 60, badge: 'free' }
                ]
            },
            groq: {
                name: 'Groq',
                models: [
                    { id: 'llama-3.3-70b-versatile', name: 'Llama 3.3 70B', context: 128000, inputPrice: 0.59, outputPrice: 0.79, rpm: 30, badge: 'free' },
                    { id: 'llama-3.1-8b-instant', name: 'Llama 3.1 8B', context: 128000, inputPrice: 0.05, outputPrice: 0.08, rpm: 30, badge: 'free' },
                    { id: 'meta-llama/llama-4-scout-17b-16e', name: 'Llama 4 Scout', context: 131000, inputPrice: 0.11, outputPrice: 0.34, rpm: 30, badge: 'free' },
                    { id: 'meta-llama/llama-4-maverick-17b-128e', name: 'Llama 4 Maverick', context: 131000, inputPrice: 0.20, outputPrice: 0.60, rpm: 30, badge: 'free' },
                    { id: 'qwen/qwen3-32b', name: 'Qwen 3 32B', context: 131000, inputPrice: 0.29, outputPrice: 0.59, rpm: 60, badge: 'free' },
                    { id: 'openai/gpt-oss-120b', name: 'GPT-OSS 120B', context: 131000, inputPrice: 0.15, outputPrice: 0.75, rpm: 30, badge: 'free' },
                    { id: 'openai/gpt-oss-20b', name: 'GPT-OSS 20B', context: 131000, inputPrice: 0.10, outputPrice: 0.50, rpm: 30, badge: 'free' },
                    { id: 'moonshotai/kimi-k2-instruct', name: 'Kimi K2', context: 262000, inputPrice: 1.00, outputPrice: 3.00, rpm: 60, badge: 'free' },
                    { 
                        id: 'whisper-large-v3', 
                        name: 'Whisper Large v3', 
                        context: 0, // Tidak pakai context window
                        inputPrice: 0.111, // per 1 menit audio
                        outputPrice: 0, 
                        rpm: 20, 
                        badge: 'free',
                        type: 'audio',
                        audioDuration: '25 hours'
                    },
                    { 
                        id: 'whisper-large-v3-turbo', 
                        name: 'Whisper Turbo', 
                        context: 0,
                        inputPrice: 0.04, // per 1 menit audio
                        outputPrice: 0, 
                        rpm: 20, 
                        badge: 'free',
                        type: 'audio',
                        audioDuration: '25 hours'
                    }
                ]
            },
            openai: {
                name: 'OpenAI',
                models: [
                    { id: 'gpt-4o', name: 'GPT-4o', context: 128000, inputPrice: 2.50, outputPrice: 10.00, rpm: 'Pay-as-you-go', badge: 'paid' },
                    { id: 'gpt-4o-mini', name: 'GPT-4o Mini', context: 128000, inputPrice: 0.15, outputPrice: 0.60, rpm: 'Pay-as-you-go', badge: 'paid' },
                    { id: 'gpt-4-turbo', name: 'GPT-4 Turbo', context: 128000, inputPrice: 10.00, outputPrice: 30.00, rpm: 'Pay-as-you-go', badge: 'paid' },
                    { id: 'gpt-3.5-turbo', name: 'GPT-3.5 Turbo', context: 16385, inputPrice: 0.50, outputPrice: 1.50, rpm: 'Pay-as-you-go', badge: 'paid' }
                ]
            },
            anthropic: {
                name: 'Claude',
                models: [
                    { id: 'claude-3-5-sonnet-20241022', name: 'Claude 3.5 Sonnet', context: 200000, inputPrice: 3.00, outputPrice: 15.00, rpm: 'Tier-based', badge: 'paid' },
                    { id: 'claude-3-opus-20240229', name: 'Claude 3 Opus', context: 200000, inputPrice: 15.00, outputPrice: 75.00, rpm: 'Tier-based', badge: 'paid' },
                    { id: 'claude-3-haiku-20240307', name: 'Claude 3 Haiku', context: 200000, inputPrice: 0.25, outputPrice: 1.25, rpm: 'Tier-based', badge: 'paid' }
                ]
            },
            cohere: {
                name: 'Cohere',
                models: [
                    { id: 'command-r-plus', name: 'Command R+', context: 128000, inputPrice: 2.50, outputPrice: 10.00, rpm: 1000, badge: 'free' },
                    { id: 'command-r', name: 'Command R', context: 128000, inputPrice: 0.50, outputPrice: 1.50, rpm: 1000, badge: 'free' },
                    { id: 'command', name: 'Command', context: 4096, inputPrice: 1.00, outputPrice: 2.00, rpm: 1000, badge: 'free' }
                ]
            },
            cerebras: {
                name: 'Cerebras',
                models: [
                    { id: 'llama-3.3-70b', name: 'Llama 3.3 70B', context: 128000, inputPrice: 0.60, outputPrice: 0.90, rpm: 30, badge: 'free' },
                    { id: 'llama-4-scout-17b-16e-instruct', name: 'Llama 4 Scout', context: 131000, inputPrice: 0.11, outputPrice: 0.34, rpm: 30, badge: 'free' },
                    { id: 'llama-4-maverick-17b-128e-instruct', name: 'Llama 4 Maverick', context: 131000, inputPrice: 0.20, outputPrice: 0.60, rpm: 30, badge: 'free' },
                    { id: 'gpt-oss-120b', name: 'GPT-OSS 120B', context: 131000, inputPrice: 0.15, outputPrice: 0.75, rpm: 30, badge: 'free' },
                    { id: 'qwen-3-32b', name: 'Qwen 3 32B', context: 131000, inputPrice: 0.29, outputPrice: 0.59, rpm: 30, badge: 'free' },
                    { id: 'zai-glm-4.7', name: 'ZAI GLM 4.7', context: 131000, inputPrice: 0.50, outputPrice: 1.00, rpm: 30, badge: 'free' },
                    { id: 'deepseek-r1-distill-llama-70b', name: 'DeepSeek R1 Distill', context: 128000, inputPrice: 0.75, outputPrice: 0.99, rpm: 30, badge: 'free' }
                ]
            },
            mistral: {
                name: 'Mistral AI',
                models: [
                    { id: 'mistral-large-latest', name: 'Mistral Large', context: 128000, inputPrice: 2.00, outputPrice: 6.00, rpm: 2, badge: 'free' },
                    { id: 'mistral-small-latest', name: 'Mistral Small', context: 128000, inputPrice: 0.10, outputPrice: 0.30, rpm: 2, badge: 'free' },
                    { id: 'codestral-latest', name: 'Codestral', context: 32000, inputPrice: 0.20, outputPrice: 0.60, rpm: 2, badge: 'free' },
                    { id: 'pixtral-large-latest', name: 'Pixtral Large (Vision)', context: 128000, inputPrice: 2.00, outputPrice: 6.00, rpm: 2, badge: 'free' },
                    { id: 'mistral-saba-2502', name: 'Mistral Saba', context: 32000, inputPrice: 0.20, outputPrice: 0.60, rpm: 2, badge: 'free' },
                    { id: 'mistral-ocr-2503', name: 'Mistral OCR', context: 0, inputPrice: 0.10, outputPrice: 0.30, rpm: 2, badge: 'free', type: 'vision' }
                ]
            },
            openrouter: {
                name: 'OpenRouter',
                models: [
                    { id: 'anthropic/claude-3.5-sonnet', name: 'Claude 3.5 Sonnet', context: 200000, inputPrice: 3.00, outputPrice: 15.00, rpm: 20, badge: 'free' },
                    { id: 'meta-llama/llama-3.3-70b-instruct', name: 'Llama 3.3 70B', context: 128000, inputPrice: 0.60, outputPrice: 0.90, rpm: 20, badge: 'free' },
                    { id: 'deepseek/deepseek-r1', name: 'DeepSeek R1', context: 128000, inputPrice: 0.55, outputPrice: 2.19, rpm: 20, badge: 'free' },
                    { id: 'google/gemini-2.5-pro-exp-03-25', name: 'Gemini 2.5 Pro', context: 1000000, inputPrice: 2.00, outputPrice: 12.00, rpm: 20, badge: 'free' },
                    { id: 'openai/gpt-4o', name: 'GPT-4o', context: 128000, inputPrice: 2.50, outputPrice: 10.00, rpm: 20, badge: 'free' },
                    { id: 'x-ai/grok-3', name: 'Grok 3', context: 131000, inputPrice: 3.00, outputPrice: 15.00, rpm: 20, badge: 'free' }
                ]
            },
            deepseek: {
                name: 'DeepSeek',
                models: [
                    { id: 'deepseek-chat', name: 'DeepSeek V3', context: 64000, inputPrice: 0.07, outputPrice: 0.27, rpm: 'No hard limit', badge: 'free' },
                    { id: 'deepseek-reasoner', name: 'DeepSeek R1', context: 64000, inputPrice: 0.27, outputPrice: 1.10, rpm: 'No hard limit', badge: 'free' }
                ]
            },
            sambanova: {
                name: 'SambaNova',
                models: [
                    { id: 'Meta-Llama-3.3-70B-Instruct', name: 'Llama 3.3 70B', context: 128000, inputPrice: 0.60, outputPrice: 0.90, rpm: 10, badge: 'free' },
                    { id: 'Qwen2.5-72B-Instruct', name: 'Qwen 2.5 72B', context: 128000, inputPrice: 0.80, outputPrice: 1.20, rpm: 10, badge: 'free' },
                    { id: 'Meta-Llama-3.1-405B-Instruct', name: 'Llama 3.1 405B', context: 128000, inputPrice: 4.00, outputPrice: 8.00, rpm: 10, badge: 'free' }
                ]
            },
            ai21: {
                name: 'AI21 Labs',
                models: [
                    { id: 'jamba-large', name: 'Jamba Large', context: 256000, inputPrice: 2.00, outputPrice: 8.00, rpm: 200, badge: 'free' },
                    { id: 'jamba-mini', name: 'Jamba Mini', context: 256000, inputPrice: 0.20, outputPrice: 0.80, rpm: 200, badge: 'free' }
                ]
            },
            cloudflare: {
                name: 'Cloudflare Workers AI',
                models: [
                    { id: '@cf/meta/llama-3.3-70b-instruct', name: 'Llama 3.3 70B', context: 32768, inputPrice: 0, outputPrice: 0, rpm: 'Unlimited', badge: 'free' },
                    { id: '@cf/mistral/mistral-7b-instruct', name: 'Mistral 7B', context: 32768, inputPrice: 0, outputPrice: 0, rpm: 'Unlimited', badge: 'free' },
                    { id: '@cf/bfl/flux-2', name: 'FLUX.2 Image', context: 0, inputPrice: 0, outputPrice: 0, rpm: 'Unlimited', badge: 'free', type: 'image' }
                ]
            },
            github: {
                name: 'GitHub Models',
                models: [
                    { id: 'gpt-4o', name: 'OpenAI GPT-4o', context: 128000, inputPrice: 2.50, outputPrice: 10.00, rpm: 10, badge: 'free' },
                    { id: 'gpt-4.1', name: 'OpenAI GPT-4.1', context: 128000, inputPrice: 2.00, outputPrice: 8.00, rpm: 10, badge: 'free' },
                    { id: 'o3-mini', name: 'OpenAI o3-mini', context: 200000, inputPrice: 1.10, outputPrice: 4.40, rpm: 10, badge: 'free' },
                    { id: 'meta-llama-3.3-70b-instruct', name: 'Llama 3.3 70B', context: 128000, inputPrice: 0.60, outputPrice: 0.90, rpm: 15, badge: 'free' },
                    { id: 'x-ai/grok-3', name: 'xAI Grok 3', context: 131000, inputPrice: 3.00, outputPrice: 15.00, rpm: 10, badge: 'free' }
                ]
            },
            together: {
                name: 'Together AI',
                models: [
                    { id: 'meta-llama/Llama-3.3-70B-Instruct-Turbo', name: 'Llama 3.3 70B Turbo', context: 128000, inputPrice: 0.88, outputPrice: 0.88, rpm: 60, badge: 'free' },
                    { id: 'meta-llama/Llama-3.1-8B-Instruct', name: 'Llama 3.1 8B', context: 8000, inputPrice: 0.10, outputPrice: 0.10, rpm: 60, badge: 'free' },
                    { id: 'mistralai/Mistral-7B-Instruct-v0.3', name: 'Mistral 7B', context: 32000, inputPrice: 0.20, outputPrice: 0.20, rpm: 60, badge: 'free' },
                    { id: 'Qwen/Qwen2.5-72B-Instruct', name: 'Qwen 2.5 72B', context: 128000, inputPrice: 0.90, outputPrice: 0.90, rpm: 60, badge: 'free' },
                    { id: 'deepseek-ai/DeepSeek-V3', name: 'DeepSeek V3', context: 64000, inputPrice: 1.25, outputPrice: 1.25, rpm: 60, badge: 'free' }
                ]
            },
            fireworks: {
                name: 'Fireworks AI',
                models: [
                    { id: 'accounts/fireworks/models/llama-v3p3-70b-instruct', name: 'Llama 3.3 70B', context: 128000, inputPrice: 0.90, outputPrice: 0.90, rpm: 60, badge: 'free' },
                    { id: 'accounts/fireworks/models/mixtral-8x22b-instruct', name: 'Mixtral 8x22B', context: 64000, inputPrice: 0.90, outputPrice: 0.90, rpm: 60, badge: 'free' },
                    { id: 'accounts/fireworks/models/qwen2p5-72b-instruct', name: 'Qwen 2.5 72B', context: 128000, inputPrice: 0.90, outputPrice: 0.90, rpm: 60, badge: 'free' },
                    { id: 'accounts/fireworks/models/deepseek-v3', name: 'DeepSeek V3', context: 64000, inputPrice: 0.90, outputPrice: 0.90, rpm: 60, badge: 'free' }
                ]
            },
            perplexity: {
                name: 'Perplexity',
                models: [
                    { id: 'sonar', name: 'Sonar (Lightweight)', context: 12000, inputPrice: 0.00, outputPrice: 0.00, rpm: 5, badge: 'free' },
                    { id: 'sonar-pro', name: 'Sonar Pro', context: 12000, inputPrice: 3.00, outputPrice: 15.00, rpm: 5, badge: 'paid' },
                    { id: 'sonar-reasoning', name: 'Sonar Reasoning', context: 12000, inputPrice: 5.00, outputPrice: 40.00, rpm: 5, badge: 'paid' }
                ]
            },
            huggingface: {
                name: 'Hugging Face',
                models: [
                    { id: 'meta-llama/Meta-Llama-3-8B-Instruct', name: 'Llama 3 8B', context: 8000, inputPrice: 0, outputPrice: 0, rpm: 'Few hundred/hour', badge: 'free' },
                    { id: 'mistralai/Mistral-7B-Instruct-v0.2', name: 'Mistral 7B', context: 32000, inputPrice: 0, outputPrice: 0, rpm: 'Few hundred/hour', badge: 'free' },
                    { id: 'google/gemma-2-9b-it', name: 'Gemma 2 9B', context: 8000, inputPrice: 0, outputPrice: 0, rpm: 'Few hundred/hour', badge: 'free' }
                ]
            },
            siliconflow: {
                name: 'SiliconFlow',
                models: [
                    { id: 'Qwen/Qwen2.5-7B-Instruct', name: 'Qwen 2.5 7B', context: 32000, inputPrice: 0, outputPrice: 0, rpm: 'Rate limit tiered', badge: 'free' },
                    { id: 'Qwen/Qwen2.5-72B-Instruct', name: 'Qwen 2.5 72B', context: 128000, inputPrice: 0, outputPrice: 0, rpm: 'Rate limit tiered', badge: 'free' },
                    { id: 'deepseek-ai/DeepSeek-V3', name: 'DeepSeek V3', context: 64000, inputPrice: 0, outputPrice: 0, rpm: 'Rate limit tiered', badge: 'free' },
                    { id: 'Pro/Qwen/Qwen2.5-7B-Instruct', name: 'Qwen 2.5 7B Pro', context: 32000, inputPrice: 0.10, outputPrice: 0.10, rpm: 'Higher limits', badge: 'paid' }
                ]
            },
            replicate: {
                name: 'Replicate',
                models: [
                    { id: 'meta/meta-llama-3-70b-instruct', name: 'Llama 3 70B', context: 8000, inputPrice: 0.65, outputPrice: 2.75, rpm: 10, badge: 'free' },
                    { id: 'mistralai/mixtral-8x7b-instruct-v0.1', name: 'Mixtral 8x7B', context: 32000, inputPrice: 0.30, outputPrice: 1.00, rpm: 10, badge: 'free' },
                    { id: 'meta/meta-llama-3-8b-instruct', name: 'Llama 3 8B', context: 8000, inputPrice: 0.05, outputPrice: 0.25, rpm: 10, badge: 'free' }
                ]
            },
            routeway: {
                name: 'Routeway',
                models: [
                    { id: 'glm-4.6:free', name: 'GLM 4.6 Free', context: 128000, inputPrice: 0, outputPrice: 0, rpm: 30, badge: 'free' },
                    { id: 'kimi-k2:free', name: 'Kimi K2 Free', context: 262000, inputPrice: 0, outputPrice: 0, rpm: 30, badge: 'free' },
                    { id: 'deepseek-chat:free', name: 'DeepSeek Chat Free', context: 64000, inputPrice: 0, outputPrice: 0, rpm: 30, badge: 'free' }
                ]
            }
        };

        let currentProvider = 'gemini';
        let currentModel = null;
        let requestHistory = JSON.parse(localStorage.getItem('aiTestHistory') || '[]');
        
        // Statistik per model - struktur: { provider_model: { inputTokens, outputTokens, requestCount, totalCost } }
        let modelStats = JSON.parse(localStorage.getItem('aiModelStats') || '{}');

        // Current session stats untuk model yang sedang aktif
        let currentSessionStats = {
            inputTokens: 0,
            outputTokens: 0,
            requestCount: 0,
            totalCost: 0
        };
    
        // File upload handling
        let uploadedFiles = [];
        let uploadedAudio = null;

        // Setup drag and drop
        document.addEventListener('DOMContentLoaded', () => {
            const uploadArea = document.getElementById('uploadArea');
            
            if (uploadArea) {
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    
                    if (e.dataTransfer.files.length > 0) {
                        processFile(e.dataTransfer.files[0]);
                    }
                });
            }
        });

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        async function processFile(file) {
            // Validasi size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showError('File terlalu besar! Maksimal 5MB.');
                return;
            }
            
            // Validasi type
            const allowedTypes = [
                'application/pdf',
                'application/msword',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'text/plain',
                'text/markdown',
                'application/json',
                'text/csv'
            ];
            
            const fileExtension = file.name.split('.').pop().toLowerCase();
            const allowedExtensions = ['pdf', 'doc', 'docx', 'txt', 'md', 'json', 'csv'];
            
            if (!allowedExtensions.includes(fileExtension)) {
                showError('Format file tidak didukung!');
                return;
            }
            
            try {
                let content = '';
                
                // Parse berdasarkan tipe file
                if (fileExtension === 'pdf') {
                    content = await parsePDF(file);
                } else if (fileExtension === 'docx' || fileExtension === 'doc') {
                    content = await parseDOCX(file);
                } else {
                    // TXT, MD, JSON, CSV
                    content = await file.text();
                }
                
                // Truncate jika terlalu panjang (max 10000 chars untuk preview)
                const previewContent = content.length > 10000 ? content.substring(0, 10000) + '... [truncated]' : content;
                
                // Simpan file
                const fileData = {
                    id: Date.now(),
                    name: file.name,
                    size: formatFileSize(file.size),
                    content: content,
                    preview: previewContent,
                    type: fileExtension
                };
                
                uploadedFiles = [fileData]; // Hanya 1 file untuk sekarang
                
                updateUploadedFilesUI();
                showSuccess(`File "${file.name}" berhasil diupload!`);
                
                // Auto isi textarea dengan instruksi
                const chatInput = document.getElementById('chatInput');
                if (chatInput && !chatInput.value.trim()) {
                    chatInput.value = `Baca dokumen yang saya upload dan berikan analisis/ringkasan.`;
                    updateTokenCount();
                }
                
            } catch (error) {
                showError(`Gagal membaca file: ${error.message}`);
            }
        }

        async function parsePDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            
            let fullText = '';
            const maxPages = Math.min(pdf.numPages, 50); // Max 50 pages
            
            for (let i = 1; i <= maxPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\n\n';
            }
            
            if (pdf.numPages > 50) {
                fullText += `\n\n[Note: Dokumen dipotong setelah 50 halaman. Total: ${pdf.numPages} halaman]`;
            }
            
            return fullText.trim();
        }

        async function parseDOCX(file) {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer });
            return result.value;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function updateUploadedFilesUI() {
            const btnUpload = document.getElementById('btnUpload');
            const uploadBtnText = document.getElementById('uploadBtnText');
            const uploadInfo = document.getElementById('uploadInfo');
            
            if (uploadedFiles.length === 0) {
                if (btnUpload) {
                    btnUpload.classList.remove('has-file');
                }
                if (uploadBtnText) uploadBtnText.textContent = 'Upload';
                if (uploadInfo) uploadInfo.style.display = 'none';
                return;
            }
            
            const file = uploadedFiles[0];
            
            if (btnUpload) {
                btnUpload.classList.add('has-file');
            }
            if (uploadBtnText) uploadBtnText.textContent = '1 File';
            
            // Info tetap di bawah, bukan di tombol
            if (uploadInfo) {
                uploadInfo.style.display = 'flex';
                document.getElementById('uploadInfoText').textContent = `${file.name} (${file.size})`;
            }
        }

        function updateAudioUI() {
            const btnAudio = document.getElementById('btnAudio');
            const audioBtnText = document.getElementById('audioBtnText');
            const audioInfo = document.getElementById('audioInfo');
            const audioFileName = document.getElementById('audioFileName');
            const audioDuration = document.getElementById('audioDuration');
            
            console.log('updateAudioUI called, uploadedAudio:', uploadedAudio);
            
            if (!uploadedAudio) {
                // Reset
                if (btnAudio) btnAudio.classList.remove('has-file');
                if (audioBtnText) audioBtnText.textContent = 'Pilih Audio';
                if (audioInfo) audioInfo.style.display = 'none';
                return;
            }
            
            // Update tombol
            if (btnAudio) btnAudio.classList.add('has-file');
            if (audioBtnText) audioBtnText.textContent = '1 Audio';
            
            // Update info
            if (audioInfo) {
                audioInfo.style.display = 'flex';
                if (audioFileName) audioFileName.textContent = uploadedAudio.name;
                if (audioDuration) audioDuration.textContent = `(${uploadedAudio.durationText})`;
            }
        }

        function updateVoiceUI() {
            const btnVoice = document.getElementById('btnVoice');
            const voiceBtnText = document.getElementById('voiceBtnText');
            const voiceStatus = document.getElementById('voiceStatus');
            
            if (isRecording) {
                if (btnVoice) {
                    btnVoice.classList.add('recording');
                }
                if (voiceBtnText) voiceBtnText.textContent = 'Stop';
                if (voiceStatus) voiceStatus.classList.add('active');
            } else {
                if (btnVoice) {
                    btnVoice.classList.remove('recording');
                }
                if (voiceBtnText) voiceBtnText.textContent = 'Voice';
                if (voiceStatus) voiceStatus.classList.remove('active');
            }
        }

        function removeUploadedFile() {
            uploadedFiles = [];
            updateUploadedFilesUI();
            showSuccess('File dihapus');
        }

        // Ganti nama fungsi clearUploadedFiles agar tidak conflict
        function clearAllUploadedFiles() {
            uploadedFiles = [];
            updateUploadedFilesUI();
        }

        function getFileIcon(type) {
            const icons = {
                pdf: 'üìï',
                doc: 'üìò',
                docx: 'üìò',
                txt: 'üìÑ',
                md: 'üìù',
                json: 'üîß',
                csv: 'üìä'
            };
            return icons[type] || 'üìé';
        }

        function removeFile(fileId) {
            uploadedFiles = uploadedFiles.filter(f => f.id !== fileId);
            updateUploadedFilesUI();
            showSuccess('File dihapus');
        }

        function clearUploadedFiles() {
            uploadedFiles = [];
            updateUploadedFilesUI();
        }

        // Voice input handling
        let recognition = null;
        let isRecording = false;

        // Inisialisasi Web Speech API
        function initVoiceInput() {
            const voiceBtn = document.getElementById('voiceBtn');
            const voiceUnsupported = document.getElementById('voiceUnsupported');
            
            // Cek browser support
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                if (voiceBtn) voiceBtn.style.display = 'none';
                if (voiceUnsupported) voiceUnsupported.style.display = 'block';
                return;
            }
            
            // Buat instance SpeechRecognition
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'id-ID'; // Bahasa Indonesia
            
            recognition.onstart = function() {
                isRecording = true;
                updateVoiceUI();
                showInfo('Mulai merekam...', 'üé§ Voice');
            };
            
            recognition.onresult = function(event) {
                let finalTranscript = '';
                let interimTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                // Update UI dengan transcript sementara
                const voiceTranscript = document.getElementById('voiceTranscript');
                if (voiceTranscript) {
                    voiceTranscript.textContent = interimTranscript || finalTranscript;
                }
                
                // Jika final, tambahkan ke textarea
                if (finalTranscript) {
                    const chatInput = document.getElementById('chatInput');
                    const currentValue = chatInput.value;
                    const separator = currentValue && !currentValue.endsWith(' ') ? ' ' : '';
                    chatInput.value = currentValue + separator + finalTranscript;
                    updateTokenCount();
                }
            };
            
            recognition.onerror = function(event) {
                console.error('Voice recognition error:', event.error);
                
                let errorMsg = 'Terjadi kesalahan saat merekam';
                switch(event.error) {
                    case 'no-speech':
                        errorMsg = 'Tidak ada suara terdeteksi';
                        break;
                    case 'audio-capture':
                        errorMsg = 'Mikrofon tidak ditemukan';
                        break;
                    case 'not-allowed':
                        errorMsg = 'Akses mikrofon ditolak';
                        break;
                    case 'network':
                        errorMsg = 'Masalah koneksi';
                        break;
                }
                
                showError(errorMsg, 'üé§ Voice Error');
                stopVoiceInput();
            };
            
            recognition.onend = function() {
                // Restart jika masih dalam mode recording (untuk continuous)
                if (isRecording) {
                    try {
                        recognition.start();
                    } catch(e) {
                        stopVoiceInput();
                    }
                } else {
                    stopVoiceInput();
                }
            };
        }

        function toggleVoiceInput() {
            if (!recognition) {
                initVoiceInput();
            }
            
            if (isRecording) {
                stopVoiceInput();
            } else {
                startVoiceInput();
            }
        }

        function startVoiceInput() {
            if (!recognition) return;
            
            try {
                recognition.start();
            } catch(e) {
                showError('Tidak bisa memulai rekaman. Coba refresh halaman.', 'üé§ Error');
            }
        }

        function stopVoiceInput() {
            isRecording = false;
            if (recognition) {
                try {
                    recognition.stop();
                } catch(e) {
                    // Ignore
                }
            }
            updateVoiceUI();
        }

        function updateVoiceUI() {
            const voiceBtn = document.getElementById('voiceBtn');
            const voiceBtnText = document.getElementById('voiceBtnText');
            const voiceStatus = document.getElementById('voiceStatus');
            const voiceTranscript = document.getElementById('voiceTranscript');
            
            if (isRecording) {
                if (voiceBtn) {
                    voiceBtn.classList.add('recording');
                    voiceBtnText.textContent = 'Stop';
                }
                if (voiceStatus) voiceStatus.classList.add('active');
                if (voiceTranscript) voiceTranscript.textContent = '';
            } else {
                if (voiceBtn) {
                    voiceBtn.classList.remove('recording');
                    voiceBtnText.textContent = 'Voice';
                }
                if (voiceStatus) voiceStatus.classList.remove('active');
                if (voiceTranscript) voiceTranscript.textContent = '';
            }
        }

        // Text-to-Speech handling
        let speechSynthesis = window.speechSynthesis;
        let currentUtterance = null;
        let isSpeaking = false;
        let speechQueue = [];
        let currentSpeechText = '';
        let speechCharIndex = 0;

        function initSpeech() {
            if (!('speechSynthesis' in window)) {
                console.warn('Browser tidak mendukung Text-to-Speech');
                return;
            }
            
            loadVoices();
            
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = loadVoices;
            }
        }

        let availableVoices = [];
        let selectedVoice = null;

        function loadVoices() {
            availableVoices = speechSynthesis.getVoices();
            
            selectedVoice = availableVoices.find(v => v.lang.startsWith('id')) ||
                        availableVoices.find(v => v.lang.startsWith('en-US')) ||
                        availableVoices.find(v => v.lang.startsWith('en-GB')) ||
                        availableVoices[0];
        }

        function speakText(text) {
            if (!text || !speechSynthesis) {
                console.warn('TTS: No text or synthesis not available');
                return;
            }
            
            // STOP semua speech yang sedang berjalan
            stopSpeech();
            
            // Simpan text yang akan diucapkan
            currentSpeechText = text;
            speechCharIndex = 0;
            
            // Split text
            const chunks = splitTextIntoChunks(text, 200);
            speechQueue = [...chunks]; // Copy array
            
            console.log('TTS: Speaking', text.substring(0, 50) + '...');
            
            // Update UI
            const audioControls = document.getElementById('audioControls');
            if (audioControls) audioControls.classList.add('active');
            
            updateAudioStatus('Memuat...');
            playNextChunk();
        }

        function splitTextIntoChunks(text, maxLength) {
            const chunks = [];
            const sentences = text.match(/[^\.!\?]+[\.!\?]+|[^\.!\?]+$/g) || [text];
            
            let currentChunk = '';
            
            for (const sentence of sentences) {
                if ((currentChunk + sentence).length <= maxLength) {
                    currentChunk += sentence;
                } else {
                    if (currentChunk) chunks.push(currentChunk.trim());
                    currentChunk = sentence;
                }
            }
            
            if (currentChunk) chunks.push(currentChunk.trim());
            
            return chunks.length > 0 ? chunks : [text];
        }

        function playNextChunk() {
            console.log('TTS: playNextChunk, queue length:', speechQueue.length);
            
            if (speechQueue.length === 0) {
                finishSpeech();
                return;
            }
            
            const chunk = speechQueue.shift();
            console.log('TTS: Speaking chunk:', chunk.substring(0, 30));
            
            currentUtterance = new SpeechSynthesisUtterance(chunk);
            
            if (selectedVoice) {
                currentUtterance.voice = selectedVoice;
                console.log('TTS: Using voice', selectedVoice.name);
            }
            
            currentUtterance.lang = selectedVoice?.lang || 'id-ID';
            currentUtterance.rate = parseFloat(document.getElementById('speechRate')?.value || 1);
            currentUtterance.pitch = 1;
            currentUtterance.volume = 1;
            
            currentUtterance.onstart = () => {
                isSpeaking = true;
                updatePlayButton(true);
                updateAudioStatus('Memutar...');
                console.log('TTS: Started speaking');
            };
            
            currentUtterance.onend = () => {
                speechCharIndex += chunk.length;
                updateProgress();
                console.log('TTS: Chunk ended, next...');
                playNextChunk();
            };
            
            currentUtterance.onerror = (e) => {
                console.error('TTS Error:', e.error);
                if (e.error !== 'canceled') {
                    updateAudioStatus('Error: ' + e.error);
                }
            };
            
            speechSynthesis.speak(currentUtterance);
        }

        function toggleSpeech() {
            // AMBIL TEXT TERBARU dari responseArea setiap kali klik
            const responseArea = document.getElementById('responseArea');
            const latestText = responseArea?.textContent?.trim() || '';
            
            console.log('TTS Toggle. Latest text:', latestText.substring(0, 50));
            console.log('TTS State - isSpeaking:', isSpeaking, 'paused:', speechSynthesis?.paused);
            
            if (isSpeaking) {
                pauseSpeech();
            } else {
                if (speechSynthesis?.paused && currentSpeechText === latestText) {
                    // Resume jika text sama
                    resumeSpeech();
                } else {
                    // Start baru dengan text terbaru
                    if (latestText && latestText !== 'Jawaban akan muncul di sini...' && latestText !== '‚è≥ AI sedang mengetik...') {
                        speakText(latestText);
                    } else {
                        showWarning('Tidak ada text untuk dibaca', '‚ö†Ô∏è TTS');
                    }
                }
            }
        }

        function pauseSpeech() {
            if (speechSynthesis) {
                speechSynthesis.pause();
                isSpeaking = false;
                updatePlayButton(false);
                updateAudioStatus('Dijeda');
            }
        }

        function resumeSpeech() {
            if (speechSynthesis) {
                speechSynthesis.resume();
                isSpeaking = true;
                updatePlayButton(true);
                updateAudioStatus('Memutar...');
            }
        }

        function stopSpeech() {
            if (speechSynthesis) {
                speechSynthesis.cancel(); // Hentikan semua
            }
            
            // RESET semua state
            speechQueue = [];
            isSpeaking = false;
            currentUtterance = null;
            currentSpeechText = '';
            speechCharIndex = 0;
            
            updatePlayButton(false);
            updateProgress(0);
            updateAudioStatus('Siap');
            
            console.log('TTS: Stopped and reset');
        }

        function finishSpeech() {
            isSpeaking = false;
            updatePlayButton(false);
            updateAudioStatus('Selesai');
            updateProgress(100);
            
            setTimeout(() => {
                updateProgress(0);
                updateAudioStatus('Siap');
            }, 2000);
        }

        function refreshTTS() {
            // Force ambil text terbaru dan mulai ulang
            const responseArea = document.getElementById('responseArea');
            const latestText = responseArea?.textContent?.trim() || '';
            
            console.log('TTS Refresh:', latestText.substring(0, 50));
            
            stopSpeech();
            
            if (latestText && latestText.length > 10) {
                setTimeout(() => {
                    speakText(latestText);
                }, 100);
            }
        }

        function updatePlayButton(playing) {
            const btn = document.getElementById('playBtn');
            if (btn) {
                btn.textContent = playing ? '‚è∏' : 'üîä';
                btn.classList.toggle('playing', playing);
            }
        }

        function updateAudioStatus(status) {
            const el = document.getElementById('audioStatus');
            if (el) el.textContent = status;
        }

        function updateProgress(percent) {
            if (percent === undefined) {
                percent = (speechCharIndex / currentSpeechText.length) * 100;
            }
            const bar = document.getElementById('audioProgressBar');
            if (bar) bar.style.width = percent + '%';
        }

        function updateSpeechRate() {
            if (currentUtterance) {
                currentUtterance.rate = parseFloat(document.getElementById('speechRate')?.value || 1);
            }
        }

        document.addEventListener('DOMContentLoaded', initSpeech);

        // Auto init saat load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Loaded');
            initSpeech();
            
            // Debug TTS
            const audioControls = document.getElementById('audioControls');
            console.log('Audio controls found:', !!audioControls);
            
            const playBtn = document.getElementById('playBtn');
            console.log('Play button found:', !!playBtn);
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Ambil nilai dari dropdown
            const providerSelect = document.getElementById('providerSelect');
            currentProvider = providerSelect ? providerSelect.value : 'gemini';
            
            console.log('Initial provider:', currentProvider);
            
            // Inisialisasi
            populateModels();
            updateModelInfo();
            loadHistory();
            
            // Load saved API key
            const savedKey = localStorage.getItem(`apiKey_${currentProvider}`);
            const apiKeyInput = document.getElementById('apiKey');
            if (savedKey && apiKeyInput) {
                apiKeyInput.value = savedKey;
            }
        });

        function switchProvider(provider) {
            // Safety check
            if (!provider || !modelConfigs[provider]) {
                console.error('Invalid provider:', provider);
                return;
            }
            
            currentProvider = provider;
            
            // Update dropdown selection
            const select = document.getElementById('providerSelect');
            if (select && select.value !== provider) {
                select.value = provider;
            }
            
            // Update label
            const label = document.getElementById('providerLabel');
            if (label) label.textContent = modelConfigs[provider].name;
            
            // Update API Key link
            const linkMap = {
                gemini: 'https://aistudio.google.com/apikey',
                groq: 'https://console.groq.com',
                openai: 'https://platform.openai.com/api-keys',
                anthropic: 'https://console.anthropic.com/settings/keys',
                cohere: 'https://dashboard.cohere.com/api-keys',
                cerebras: 'https://cloud.cerebras.ai',
                mistral: 'https://console.mistral.ai/api-keys',
                openrouter: 'https://openrouter.ai/keys',
                deepseek: 'https://platform.deepseek.com/api_keys',
                sambanova: 'https://cloud.sambanova.ai/apis',
                ai21: 'https://studio.ai21.com/account/api-key',
                cloudflare: 'https://dash.cloudflare.com/profile/api-tokens',
                github: 'https://github.com/settings/tokens',
                together: 'https://api.together.xyz/settings/api-keys',
                fireworks: 'https://app.fireworks.ai/users/settings/api-keys',
                perplexity: 'https://www.perplexity.ai/settings/api',
                huggingface: 'https://huggingface.co/settings/tokens',
                siliconflow: 'https://cloud.siliconflow.cn/account/ak',
                replicate: 'https://replicate.com/account/api-tokens',
                routeway: 'https://routeway.ai/dashboard/api-keys'
            };
            
            const linkElement = document.getElementById('apiKeyLink');
            if (linkElement) {
                linkElement.href = linkMap[provider] || '#';
                const linkName = document.getElementById('providerLinkName');
                if (linkName) linkName.textContent = modelConfigs[provider].name;
            }
            
            // Populate models
            populateModels();
            updateModelInfo();
            
            // Reset current session stats display
            currentSessionStats = {
                inputTokens: 0,
                outputTokens: 0,
                requestCount: 0,
                totalCost: 0
            };
            updateStatsDisplay();

            // Load saved API key for this provider
            const savedKey = localStorage.getItem(`apiKey_${provider}`);
            const apiKeyInput = document.getElementById('apiKey');
            if (apiKeyInput) apiKeyInput.value = savedKey || '';
        }

        function populateModels() {
            const select = document.getElementById('modelSelect');
            if (!select) {
                console.error('Model select element not found');
                return;
            }
            
            // Clear existing options
            select.innerHTML = '';
            
            // Safety check dengan fallback
            if (!currentProvider || !modelConfigs[currentProvider]) {
                console.warn('Invalid provider:', currentProvider, 'fallback to gemini');
                currentProvider = 'gemini';
                
                // Update dropdown juga
                const providerSelect = document.getElementById('providerSelect');
                if (providerSelect) providerSelect.value = 'gemini';
            }
            
            const config = modelConfigs[currentProvider];
            
            if (!config || !Array.isArray(config.models)) {
                console.error('Invalid config for provider:', currentProvider);
                return;
            }
            
            // Populate options
            config.models.forEach((model, index) => {
                const option = document.createElement('option');
                option.value = model.id;
                
                const badge = model.badge === 'free' ? 'üü¢' : model.badge === 'paid' ? 'üí∞' : 'üîµ';
                let text = `${badge} ${model.name}`;
                
                if (model.type === 'audio') text += ' (Audio)';
                if (model.type === 'vision') text += ' (Vision)';
                if (model.type === 'image') text += ' (Image)';
                
                option.textContent = text;
                select.appendChild(option);
                
                // Set first model as current
                if (index === 0) currentModel = model;
            });
            
            // Initialize stats untuk model ini jika belum ada
            const statsKey = `${currentProvider}_${currentModel.id}`;
            if (!modelStats[statsKey]) {
                modelStats[statsKey] = {
                    inputTokens: 0,
                    outputTokens: 0,
                    requestCount: 0,
                    totalCost: 0,
                    lastUsed: null
                };
            }

            // Load stats untuk model ini
            currentSessionStats = { ...modelStats[statsKey] };
            updateStatsDisplay();

            console.log('Populated', config.models.length, 'models for', currentProvider);
        }

        // Toggle UI berdasarkan model type
        function updateModelSpecificUI() {
            const btnTeksUji = document.getElementById('btnTeksUji');
            const btnUpload = document.getElementById('btnUpload');
            const btnVoice = document.getElementById('btnVoice');
            const btnAudio = document.getElementById('btnAudio');
            const voiceStatus = document.getElementById('voiceStatus');
            const uploadInfo = document.getElementById('uploadInfo');
            const audioInfo = document.getElementById('audioInfo');
            const chatInput = document.getElementById('chatInput');
            
            if (!currentModel) return;
            
            // Reset semua tombol ke display default
            const allButtons = [btnTeksUji, btnUpload, btnVoice, btnAudio];
            
            if (currentModel.type === 'audio') {
                // Mode Whisper - hanya Audio + Kirim
                if (btnTeksUji) btnTeksUji.style.display = 'none';
                if (btnUpload) btnUpload.style.display = 'none';
                if (btnVoice) btnVoice.style.display = 'none';
                if (voiceStatus) voiceStatus.style.display = 'none';
                if (uploadInfo) uploadInfo.style.display = 'none';
                
                if (btnAudio) {
                    btnAudio.style.display = 'inline-flex';
                    btnAudio.classList.add('btn-action'); // Pastikan class ada
                }
                if (audioInfo) audioInfo.style.display = 'flex';
                
                if (chatInput) {
                    chatInput.placeholder = 'Transkripsi akan muncul di sini...';
                    chatInput.readOnly = true;
                }
                
            } else {
                // Mode Chat - Teks Uji, Upload, Voice + Kirim
                if (btnTeksUji) {
                    btnTeksUji.style.display = 'inline-flex';
                    btnTeksUji.classList.add('btn-action');
                }
                if (btnUpload) {
                    btnUpload.style.display = 'inline-flex';
                    btnUpload.classList.add('btn-action');
                }
                if (btnVoice) {
                    btnVoice.style.display = 'inline-flex';
                    btnVoice.classList.add('btn-action');
                }
                
                // Sembunyikan Audio
                if (btnAudio) btnAudio.style.display = 'none';
                if (audioInfo) audioInfo.style.display = 'none';
                
                if (chatInput) {
                    chatInput.placeholder = 'Ketik pesan...';
                    chatInput.readOnly = false;
                }
                
                updateUploadedFilesUI();
            }
        }

        function updateModelInfo() {
            const modelSelect = document.getElementById('modelSelect');
            if (!modelSelect) return;
            
            const modelId = modelSelect.value;
            
            // Safety check
            if (!currentProvider || !modelConfigs[currentProvider]) {
                console.error('No provider selected');
                return;
            }
            
            currentModel = modelConfigs[currentProvider].models.find(m => m.id === modelId);
            
            if (!currentModel) {
                console.error('Model not found:', modelId);
                return;
            }
            
            const badgeClass = currentModel.badge === 'free' ? 'badge-free' : 'badge-paid';
            const badgeText = currentModel.badge === 'free' ? 'FREE' : 'PAID';
            
            const modelInfo = document.getElementById('modelInfo');
            if (modelInfo) {
                let infoHTML = `
                    <strong>${currentModel.name}</strong> <span class="badge ${badgeClass}">${badgeText}</span><br>
                    <strong>Context:</strong> ${currentModel.context.toLocaleString()} tokens<br>
                    <strong>Input:</strong> $${currentModel.inputPrice}/1M<br>
                    <strong>Output:</strong> $${currentModel.outputPrice}/1M<br>
                    <strong>Limit:</strong> ${currentModel.rpm} RPM
                `;
                
                if (currentModel.type === 'audio') {
                    infoHTML += `<br><span style="color: #ff9800;">‚ö†Ô∏è Audio model</span>`;
                }
                
                modelInfo.innerHTML = infoHTML;
            }
            
            const rateLimit = document.getElementById('rateLimit');
            if (rateLimit) rateLimit.textContent = currentModel.rpm + ' RPM';
            
            updateTokenCount();
            
            // Load stats untuk model yang dipilih
            const statsKey = `${currentProvider}_${currentModel.id}`;
            if (modelStats[statsKey]) {
                currentSessionStats = { ...modelStats[statsKey] };
            } else {
                currentSessionStats = { inputTokens: 0, outputTokens: 0, requestCount: 0, totalCost: 0 };
            }
            updateStatsDisplay();
            // Update UI spesifik model
            updateModelSpecificUI();
        }

        async function handleAudioUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                console.log('No file selected');
                return;
            }
            
            console.log('Audio file selected:', file.name, file.size, file.type);
            
            // Validasi size (max 25MB untuk Groq)
            if (file.size > 25 * 1024 * 1024) {
                showError('File audio terlalu besar! Maksimal 25MB.');
                event.target.value = ''; // Reset input
                return;
            }
            
            // Validasi extension
            const fileExtension = file.name.split('.').pop().toLowerCase();
            const allowedExtensions = ['mp3', 'wav', 'm4a', 'flac', 'ogg', 'webm', 'mp4', 'mpeg', 'mpga', 'oga'];
            
            if (!allowedExtensions.includes(fileExtension)) {
                showError('Format audio tidak didukung! Gunakan MP3, WAV, M4A, FLAC, OGG, atau WEBM.');
                event.target.value = ''; // Reset input
                return;
            }
            
            try {
                // Get audio duration
                const duration = await getAudioDuration(file);
                console.log('Audio duration:', duration);
                
                uploadedAudio = {
                    file: file,
                    name: file.name,
                    size: formatFileSize(file.size),
                    duration: duration,
                    durationText: formatDuration(duration),
                    extension: fileExtension
                };
                
                console.log('Audio uploaded:', uploadedAudio);
                
                updateAudioUI();
                showSuccess(`Audio "${file.name}" siap ditranskripsi! (${uploadedAudio.durationText})`);
                
            } catch (error) {
                console.error('Error processing audio:', error);
                showError('Gagal memproses file audio: ' + error.message);
                event.target.value = ''; // Reset input
            }
        }

        function getAudioDuration(file) {
            return new Promise((resolve, reject) => {
                const audio = new Audio();
                const objectUrl = URL.createObjectURL(file);
                
                audio.onloadedmetadata = () => {
                    URL.revokeObjectURL(objectUrl);
                    resolve(audio.duration);
                };
                
                audio.onerror = () => {
                    URL.revokeObjectURL(objectUrl);
                    // Fallback: estimasi 1MB = 1 menit
                    const estimatedDuration = (file.size / (1024 * 1024)) * 60;
                    resolve(estimatedDuration);
                };
                
                // Timeout fallback
                setTimeout(() => {
                    if (!audio.duration) {
                        URL.revokeObjectURL(objectUrl);
                        const estimatedDuration = (file.size / (1024 * 1024)) * 60;
                        resolve(estimatedDuration);
                    }
                }, 3000);
                
                audio.src = objectUrl;
            });
        }

        function formatDuration(seconds) {
            if (!seconds || isNaN(seconds)) return '0:00';
            
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function updateAudioUI() {
            const btnAudio = document.getElementById('btnAudio');
            const btnAudioText = document.getElementById('audioBtnText');
            const audioInfo = document.getElementById('audioInfo');
            const audioFileName = document.getElementById('audioFileName');
            const audioDuration = document.getElementById('audioDuration');
            
            if (!uploadedAudio) {
                // Reset tombol
                if (btnAudio) {
                    btnAudio.classList.remove('has-file');
                    btnAudioText.textContent = 'Pilih Audio';
                }
                if (audioInfo) audioInfo.style.display = 'none';
                return;
            }
            
            // Update tombol audio (indikasi ada file)
            if (btnAudio) {
                btnAudio.classList.add('has-file');
                btnAudioText.textContent = '1 Audio';
            }
            
            // Tampilkan info audio
            if (audioInfo) {
                audioInfo.style.display = 'flex';
                audioFileName.textContent = uploadedAudio.name;
                audioDuration.textContent = `(${uploadedAudio.durationText})`;
            }
        }

        function removeAudioFile() {
            uploadedAudio = null;
            
            // Reset input file
            const audioInput = document.getElementById('audioInput');
            if (audioInput) audioInput.value = '';
            
            updateAudioUI();
            showSuccess('Audio dihapus');
        }

        // API call untuk Whisper
        async function callWhisper(apiKey, audioFile) {
            const formData = new FormData();
            formData.append('file', audioFile);
            formData.append('model', currentModel.id);
            formData.append('language', 'id');
            formData.append('response_format', 'json');
            
            console.log('Calling Whisper API with model:', currentModel.id);
            
            const response = await fetch('https://api.groq.com/openai/v1/audio/transcriptions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`
                    // Jangan set Content-Type, browser akan set dengan boundary
                },
                body: formData
            });
            
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.error?.message || `Whisper error: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Whisper response:', data);
            
            // Update stats (estimasi)
            const estimatedTokens = Math.ceil((uploadedAudio?.duration || 0) / 60 * 100);
            document.getElementById('inputTokens').textContent = estimatedTokens;
            document.getElementById('outputTokens').textContent = data.text?.length || 0;
            
            return data.text || 'Tidak ada transkripsi';
        }

        function toggleApiKey() {
            const input = document.getElementById('apiKey');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function saveApiKey() {
            const key = document.getElementById('apiKey').value.trim();
            if (key) {
                localStorage.setItem(`apiKey_${currentProvider}`, key);
                showSuccess(
                    `API Key untuk ${modelConfigs[currentProvider].name} berhasil disimpan!`,
                    'üíæ Tersimpan'
                );
            } else {
                showError(
                    'API Key tidak boleh kosong. Silakan masukkan key yang valid.',
                    '‚ö†Ô∏è Validasi Gagal'
                );
            }
        }

        function updateTokenCount() {
            const text = document.getElementById('chatInput').value;
            const statsKey = `${currentProvider}_${currentModel?.id || 'unknown'}`;
            
            // Estimasi token input (roughly 1 token = 3-4 chars untuk bahasa Indonesia)
            const estimatedInput = Math.ceil(text.length / 3.5);
            
            // Update display input tokens
            document.getElementById('inputTokenCount').textContent = `${estimatedInput.toLocaleString()} tokens (est)`;
            
            // Update visual bar dengan data REAL dari modelStats + current session
            if (currentModel && currentModel.context > 0) {
                const savedStats = modelStats[statsKey] || { inputTokens: 0, outputTokens: 0 };
                const totalUsedTokens = savedStats.inputTokens + savedStats.outputTokens + estimatedInput;
                const percentage = Math.min((totalUsedTokens / currentModel.context) * 100, 100);
                
                const bar = document.getElementById('tokenBar');
                const warning = document.getElementById('limitWarning');
                
                bar.style.width = percentage + '%';
                bar.textContent = percentage < 10 ? percentage.toFixed(1) + '%' : Math.round(percentage) + '%';
                
                // Color coding
                if (percentage >= 90) {
                    bar.style.background = 'linear-gradient(90deg, #f44336 0%, #ff5722 100%)';
                    warning.style.display = 'block';
                    warning.textContent = '‚ö†Ô∏è CRITICAL: Mendekati batas context!';
                } else if (percentage >= 75) {
                    bar.style.background = 'linear-gradient(90deg, #ff9800 0%, #ffc107 100%)';
                    warning.style.display = 'block';
                    warning.textContent = '‚ö†Ô∏è Warning: Context > 75%';
                } else {
                    bar.style.background = 'linear-gradient(90deg, #667eea 0%, #764ba2 100%)';
                    warning.style.display = 'none';
                }
                
                // Update tooltip/info
                const contextInfo = `${totalUsedTokens.toLocaleString()} / ${currentModel.context.toLocaleString()} tokens`;
                bar.title = `Total terpakai: ${contextInfo}\nEstimasi input: ${estimatedInput}\nTersisa: ${(currentModel.context - totalUsedTokens).toLocaleString()}`;
            }
            
            // Update cost estimation untuk request ini
            if (currentModel) {
                const inputCost = (estimatedInput / 1000000) * currentModel.inputPrice;
                document.getElementById('estCost').textContent = '$' + inputCost.toFixed(6);
            }
        }

        function updateStatsDisplay() {
            const statsKey = `${currentProvider}_${currentModel?.id || 'unknown'}`;
            const savedStats = modelStats[statsKey] || { inputTokens: 0, outputTokens: 0, requestCount: 0, totalCost: 0 };
            
            // Merge dengan current session
            const displayStats = {
                inputTokens: savedStats.inputTokens,
                outputTokens: savedStats.outputTokens,
                requestCount: savedStats.requestCount,
                totalCost: savedStats.totalCost
            };
            
            // Update display
            document.getElementById('inputTokens').textContent = displayStats.inputTokens.toLocaleString();
            document.getElementById('outputTokens').textContent = displayStats.outputTokens.toLocaleString();
            document.getElementById('totalTokens').textContent = (displayStats.inputTokens + displayStats.outputTokens).toLocaleString();
            document.getElementById('estCost').textContent = '$' + displayStats.totalCost.toFixed(4);
            
            // Update rate limit dengan request count
            const rateLimitEl = document.getElementById('rateLimit');
            if (rateLimitEl && currentModel) {
                rateLimitEl.innerHTML = `${currentModel.rpm} RPM <span style="font-size:0.75em;opacity:0.7">(${displayStats.requestCount} req)</span>`;
            }
            
            // Update context usage info
            updateContextInfo(displayStats);
        }

        function updateContextInfo(stats) {
            if (!currentModel) return;
            
            const contextFraction = document.getElementById('contextFraction');
            const contextModelName = document.getElementById('contextModelName');
            const contextRemaining = document.getElementById('contextRemaining');
            
            if (contextFraction) {
                const totalUsed = stats.inputTokens + stats.outputTokens;
                contextFraction.textContent = `${totalUsed.toLocaleString()} / ${currentModel.context.toLocaleString()}`;
            }
            
            if (contextModelName) {
                contextModelName.textContent = currentModel.name.length > 15 
                    ? currentModel.name.substring(0, 15) + '...' 
                    : currentModel.name;
            }
            
            if (contextRemaining) {
                const remaining = currentModel.context - (stats.inputTokens + stats.outputTokens);
                const color = remaining < 10000 ? '#f44336' : remaining < 50000 ? '#ff9800' : '#4caf50';
                contextRemaining.innerHTML = `Sisa: <span style="color: ${color}; font-weight: 600;">${remaining.toLocaleString()}</span>`;
            }
        }

        function saveModelStats() {
            if (!currentProvider || !currentModel) return;
            
            const statsKey = `${currentProvider}_${currentModel.id}`;
            modelStats[statsKey] = {
                ...currentSessionStats,
                lastUsed: new Date().toISOString()
            };
            
            localStorage.setItem('aiModelStats', JSON.stringify(modelStats));
        }

        async function sendMessage() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const message = document.getElementById('chatInput').value.trim();
            const responseArea = document.getElementById('responseArea');
            const sendBtn = document.getElementById('sendBtn');
            
            if (!apiKey) {
                showError('Silakan masukkan API Key terlebih dahulu!');
                return;
            }
            
            // Handle Whisper (Audio) Model
            if (currentModel?.type === 'audio') {
                if (!uploadedAudio) {
                    showError('Silakan upload file audio terlebih dahulu!');
                    return;
                }
                
                sendBtn.disabled = true;
                responseArea.textContent = '‚è≥ Mentranskripsi audio...';
                
                try {
                    const startTime = Date.now();
                    const transcript = await callWhisper(apiKey, uploadedAudio.file);
                    const duration = ((Date.now() - startTime) / 1000).toFixed(2);
                    
                    document.getElementById('chatInput').value = transcript;
                    responseArea.textContent = '‚úÖ Transkripsi selesai! Pilih model chat untuk melanjutkan.';
                    
                    document.getElementById('responseTime').textContent = `${duration}s`;
                    
                    const audioMinutes = (uploadedAudio?.duration || 0) / 60;
                    const cost = audioMinutes * currentModel.inputPrice;
                    currentSessionStats.totalCost += cost;
                    currentSessionStats.requestCount += 1;
                    saveModelStats();
                    updateStatsDisplay();
                    
                    addToHistory(`[Whisper: ${uploadedAudio.name}]`, transcript, duration);
                    showSuccess('Transkripsi selesai! Pilih model chat untuk melanjutkan.', '‚úÖ Whisper');
                    
                } catch (error) {
                    responseArea.innerHTML = `<span style="color: #c62828;">Error: ${error.message}</span>`;
                    showError(error.message);
                } finally {
                    sendBtn.disabled = false;
                }
                
                return;
            }
            
            // Handle Chat Model
            if (!message && uploadedFiles.length === 0) {
                showError('Silakan ketik pesan atau upload dokumen!');
                return;
            }
            
            let fullMessage = message;
            if (uploadedFiles.length > 0) {
                const file = uploadedFiles[0];
                const fileHeader = `\n\n---\nüìé KONTEN DOKUMEN: ${file.name}\n---\n\n`;
                fullMessage = message + fileHeader + file.content;
                
                if (fullMessage.length > (currentModel?.context || 0) * 3) {
                    showWarning('Konten dokumen sangat panjang! Mungkin terpotong oleh model.');
                }
            }
            
            // Reset dan siapkan UI
            sendBtn.disabled = true;
            responseArea.innerHTML = '<span style="color: #667eea;">‚è≥ AI sedang mengetik...</span>';
            
            // Sembunyikan audio controls sementara
            const audioControls = document.getElementById('audioControls');
            if (audioControls) audioControls.classList.remove('active');
            
            const startTime = Date.now();
            let fullResponse = '';
            let hasReceivedChunk = false;
            
            try {
                await streamAIResponse(apiKey, fullMessage, (chunk) => {
                    if (!hasReceivedChunk) {
                        fullResponse = chunk;
                        hasReceivedChunk = true;
                        responseArea.textContent = fullResponse;
                    } else {
                        fullResponse += chunk;
                        responseArea.textContent = fullResponse;
                    }
                    
                    responseArea.scrollTop = responseArea.scrollHeight;
                });
                
                if (!hasReceivedChunk) {
                    throw new Error('Tidak ada response dari AI');
                }
                
                const endTime = Date.now();
                const duration = ((endTime - startTime) / 1000).toFixed(2);
                
                // Display response (ini akan aktifkan TTS)
                displayResponse(fullResponse, duration);
                
                // Update stats
                const estimatedInput = Math.ceil(fullMessage.length / 3.5);
                const estimatedOutput = Math.ceil(fullResponse.length / 3.5);
                
                document.getElementById('inputTokens').textContent = estimatedInput;
                document.getElementById('outputTokens').textContent = estimatedOutput;
                document.getElementById('totalTokens').textContent = estimatedInput + estimatedOutput;
                
                const inputCost = (estimatedInput / 1000000) * (currentModel?.inputPrice || 0);
                const outputCost = (estimatedOutput / 1000000) * (currentModel?.outputPrice || 0);
                currentSessionStats.inputTokens += estimatedInput;
                currentSessionStats.outputTokens += estimatedOutput;
                currentSessionStats.totalCost += (inputCost + outputCost);
                currentSessionStats.requestCount += 1;
                saveModelStats();
                updateStatsDisplay();
                updateTokenCount();
                
                addToHistory(message || `[Dokumen: ${uploadedFiles[0]?.name || 'file'}]`, fullResponse, duration);
                
            } catch (error) {
                responseArea.innerHTML = `<span style="color: #c62828;">Error: ${error.message}</span>`;
                showError(error.message);
            } finally {
                sendBtn.disabled = false;
            }
        }

        // Streaming response handler
        async function streamAIResponse(apiKey, message, onChunk) {
            const provider = currentProvider;
            
            // Gemini pakai non-streaming (lebih reliable)
            if (provider === 'gemini') {
                const response = await callGemini(apiKey, message);
                onChunk(response);
                return;
            }
            
            // Provider lain pakai streaming
            const nonStreamingProviders = [
                'ai21', 'sambanova', 'cloudflare', 
                'huggingface', 'replicate'
            ];
            
            if (nonStreamingProviders.includes(provider)) {
                const response = await callNonStreaming(apiKey, message);
                onChunk(response);
                return;
            }
            
            // Build endpoint & headers untuk streaming providers
            let url, headers, body;
            
            switch(provider) {
                case 'openai':
                    url = 'https://api.openai.com/v1/chat/completions';
                    headers = { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' };
                    body = { model: currentModel.id, messages: [{ role: 'user', content: message }], stream: true };
                    break;
                    
                case 'github':
                    url = 'https://models.inference.ai.azure.com/chat/completions';
                    headers = { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' };
                    body = { model: currentModel.id, messages: [{ role: 'user', content: message }], stream: true };
                    break;
                    
                case 'anthropic':
                    url = 'https://api.anthropic.com/v1/messages';
                    headers = { 'x-api-key': apiKey, 'Content-Type': 'application/json', 'anthropic-version': '2023-06-01' };
                    body = { model: currentModel.id, max_tokens: 4096, messages: [{ role: 'user', content: message }], stream: true };
                    break;
                    
                case 'groq':
                    url = 'https://api.groq.com/openai/v1/chat/completions';
                    headers = { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' };
                    body = { model: currentModel.id, messages: [{ role: 'user', content: message }], stream: true };
                    break;
                    
                case 'cerebras':
                    url = 'https://api.cerebras.ai/v1/chat/completions';
                    headers = { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' };
                    body = { model: currentModel.id, messages: [{ role: 'user', content: message }], stream: true };
                    break;
                    
                case 'mistral':
                    url = 'https://api.mistral.ai/v1/chat/completions';
                    headers = { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' };
                    body = { model: currentModel.id, messages: [{ role: 'user', content: message }], stream: true };
                    break;
                    
                case 'deepseek':
                    url = 'https://api.deepseek.com/chat/completions';
                    headers = { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' };
                    body = { model: currentModel.id, messages: [{ role: 'user', content: message }], stream: true };
                    break;
                    
                case 'openrouter':
                    url = 'https://openrouter.ai/api/v1/chat/completions';
                    headers = { 
                        'Authorization': `Bearer ${apiKey}`, 
                        'HTTP-Referer': window.location.href, 
                        'X-Title': 'AI Token Tester',
                        'Content-Type': 'application/json' 
                    };
                    body = { model: currentModel.id, messages: [{ role: 'user', content: message }], stream: true };
                    break;
                    
                case 'together':
                    url = 'https://api.together.xyz/v1/chat/completions';
                    headers = { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' };
                    body = { model: currentModel.id, messages: [{ role: 'user', content: message }], stream: true };
                    break;
                    
                case 'fireworks':
                    url = 'https://api.fireworks.ai/inference/v1/chat/completions';
                    headers = { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' };
                    body = { model: currentModel.id, messages: [{ role: 'user', content: message }], stream: true };
                    break;
                    
                case 'perplexity':
                    url = 'https://api.perplexity.ai/chat/completions';
                    headers = { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' };
                    body = { model: currentModel.id, messages: [{ role: 'user', content: message }], stream: true };
                    break;
                    
                case 'siliconflow':
                    url = 'https://api.siliconflow.cn/v1/chat/completions';
                    headers = { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' };
                    body = { model: currentModel.id, messages: [{ role: 'user', content: message }], stream: true };
                    break;
                    
                case 'routeway':
                    url = 'https://api.routeway.ai/v1/chat/completions';
                    headers = { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' };
                    body = { model: currentModel.id, messages: [{ role: 'user', content: message }], stream: true };
                    break;
                    
                case 'cohere':
                    url = 'https://api.cohere.ai/v1/chat/completions';
                    headers = { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' };
                    body = { model: currentModel.id, messages: [{ role: 'user', content: message }], stream: true };
                    break;
                    
                default:
                    const response = await callNonStreaming(apiKey, message);
                    onChunk(response);
                    return;
            }
            
            // Fetch dengan streaming
            const response = await fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(body)
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }
            
            // Process SSE stream
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let firstChunk = true;
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop();
                
                for (const line of lines) {
                    const chunk = parseStreamChunk(line);
                    if (chunk) {
                        onChunk(chunk);
                        firstChunk = false;
                    }
                }
            }
            
            // Process sisa buffer
            if (buffer.trim()) {
                const chunk = parseStreamChunk(buffer);
                if (chunk) onChunk(chunk);
            }
        }

        // Parse chunk dari berbagai format streaming
        function parseStreamChunk(line) {
            line = line.trim();
            if (!line || line === 'data: [DONE]') return null;
            
            if (!line.startsWith('data: ')) return null;
            
            const jsonStr = line.slice(6);
            if (!jsonStr) return null;
            
            try {
                const data = JSON.parse(jsonStr);
                
                // OpenAI/Groq/Cerebras/Mistral/DeepSeek/Together/Fireworks format
                if (data.choices?.[0]?.delta?.content) {
                    return data.choices[0].delta.content;
                }
                
                if (data.choices?.[0]?.text) {
                    return data.choices[0].text;
                }
                
                // Anthropic format
                if (data.type === 'content_block_delta' && data.delta?.text) {
                    return data.delta.text;
                }
                
                if (data.delta?.text) {
                    return data.delta.text;
                }
                
            } catch (e) {
                return null;
            }
            
            return null;
        }

        // Fallback non-streaming
        async function callNonStreaming(apiKey, message) {
            switch(currentProvider) {
                case 'gemini': 
                    return await callGemini(apiKey, message);
                case 'groq': 
                    return await callGroq(apiKey, message);
                case 'cerebras': 
                    return await callCerebras(apiKey, message);
                case 'mistral': 
                    return await callMistral(apiKey, message);
                case 'openrouter': 
                    return await callOpenRouter(apiKey, message);
                case 'deepseek': 
                    return await callDeepSeek(apiKey, message);
                case 'sambanova': 
                    return await callSambaNova(apiKey, message);
                case 'ai21': 
                    return await callAI21(apiKey, message);
                case 'cloudflare': 
                    return await callCloudflare(apiKey, message);
                case 'github': 
                    return await callGitHub(apiKey, message);
                case 'together': 
                    return await callTogether(apiKey, message);
                case 'fireworks': 
                    return await callFireworks(apiKey, message);
                case 'perplexity': 
                    return await callPerplexity(apiKey, message);
                case 'huggingface': 
                    return await callHuggingFace(apiKey, message);
                case 'siliconflow': 
                    return await callSiliconFlow(apiKey, message);
                case 'replicate': 
                    return await callReplicate(apiKey, message);
                case 'routeway': 
                    return await callRouteway(apiKey, message);
                case 'openai': 
                    return await callOpenAI(apiKey, message);
                case 'anthropic': 
                    return await callAnthropic(apiKey, message);
                case 'cohere': 
                    return await callCohere(apiKey, message);
                default: 
                    throw new Error(`Provider ${currentProvider} tidak memiliki handler non-streaming`);
            }
        }

        async function callGemini(apiKey, message) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${currentModel.id}:generateContent?key=${apiKey}`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: message
                        }]
                    }]
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || `Gemini error: ${response.status}`);
            }
            
            const data = await response.json();
            
            // Extract text dari berbagai kemungkinan format
            let text = '';
            
            if (data.candidates && data.candidates[0]) {
                const candidate = data.candidates[0];
                
                if (candidate.content && candidate.content.parts) {
                    // Gabungkan semua parts
                    text = candidate.content.parts.map(part => part.text || '').join('');
                }
                
                if (candidate.finishReason === 'SAFETY') {
                    text = '[Response blocked due to safety settings]';
                }
            }
            
            if (!text && data.promptFeedback) {
                text = `[Blocked: ${data.promptFeedback.blockReason || 'Unknown reason'}]`;
            }
            
            // Update token stats
            if (data.usageMetadata) {
                document.getElementById('inputTokens').textContent = data.usageMetadata.promptTokenCount || 0;
                document.getElementById('outputTokens').textContent = data.usageMetadata.candidatesTokenCount || 0;
                document.getElementById('totalTokens').textContent = data.usageMetadata.totalTokenCount || 0;
            }
            
            return text || 'Tidak ada response';
        }

        async function callGroq(apiKey, message) {
            const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: currentModel.id,
                    messages: [{
                        role: 'user',
                        content: message
                    }]
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Unknown error');
            }
            
            const data = await response.json();
            
            // Update token stats
            if (data.usage) {
                document.getElementById('inputTokens').textContent = data.usage.prompt_tokens || 0;
                document.getElementById('outputTokens').textContent = data.usage.completion_tokens || 0;
                document.getElementById('totalTokens').textContent = data.usage.total_tokens || 0;
            }
            
            return data.choices[0].message.content;
        }

        async function callOpenAI(apiKey, message) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: currentModel.id,
                    messages: [{
                        role: 'user',
                        content: message
                    }]
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Unknown error');
            }
            
            const data = await response.json();
            
            if (data.usage) {
                document.getElementById('inputTokens').textContent = data.usage.prompt_tokens || 0;
                document.getElementById('outputTokens').textContent = data.usage.completion_tokens || 0;
                document.getElementById('totalTokens').textContent = data.usage.total_tokens || 0;
            }
            
            return data.choices[0].message.content;
        }

        async function callAnthropic(apiKey, message) {
            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'x-api-key': apiKey,
                    'Content-Type': 'application/json',
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: currentModel.id,
                    max_tokens: 4096,
                    messages: [{
                        role: 'user',
                        content: message
                    }]
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Unknown error');
            }
            
            const data = await response.json();
            
            if (data.usage) {
                document.getElementById('inputTokens').textContent = data.usage.input_tokens || 0;
                document.getElementById('outputTokens').textContent = data.usage.output_tokens || 0;
                document.getElementById('totalTokens').textContent = (data.usage.input_tokens + data.usage.output_tokens) || 0;
            }
            
            return data.content[0].text;
        }

        async function callCohere(apiKey, message) {
            const response = await fetch('https://api.cohere.ai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: currentModel.id,
                    messages: [{ role: 'user', content: message }]
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Cohere API error');
            }
            
            const data = await response.json();
            
            // Update token stats if available
            if (data.usage) {
                document.getElementById('inputTokens').textContent = data.usage.prompt_tokens || 0;
                document.getElementById('outputTokens').textContent = data.usage.completion_tokens || 0;
                document.getElementById('totalTokens').textContent = data.usage.total_tokens || 0;
            }
            
            return data.choices[0].message.content;
        }

        async function callCerebras(apiKey, message) {
            const response = await fetch('https://api.cerebras.ai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: currentModel.id,
                    messages: [{ role: 'user', content: message }]
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Cerebras API error');
            }
            
            const data = await response.json();
            if (data.usage) {
                document.getElementById('inputTokens').textContent = data.usage.prompt_tokens || 0;
                document.getElementById('outputTokens').textContent = data.usage.completion_tokens || 0;
                document.getElementById('totalTokens').textContent = data.usage.total_tokens || 0;
            }
            
            return data.choices[0].message.content;
        }

        async function callMistral(apiKey, message) {
            const response = await fetch('https://api.mistral.ai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: currentModel.id,
                    messages: [{ role: 'user', content: message }]
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Mistral API error');
            }
            
            const data = await response.json();
            if (data.usage) {
                document.getElementById('inputTokens').textContent = data.usage.prompt_tokens || 0;
                document.getElementById('outputTokens').textContent = data.usage.completion_tokens || 0;
                document.getElementById('totalTokens').textContent = data.usage.total_tokens || 0;
            }
            
            return data.choices[0].message.content;
        }

        async function callOpenRouter(apiKey, message) {
            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'HTTP-Referer': window.location.href,
                    'X-Title': 'AI Token Tester',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: currentModel.id,
                    messages: [{ role: 'user', content: message }]
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'OpenRouter API error');
            }
            
            const data = await response.json();
            if (data.usage) {
                document.getElementById('inputTokens').textContent = data.usage.prompt_tokens || 0;
                document.getElementById('outputTokens').textContent = data.usage.completion_tokens || 0;
                document.getElementById('totalTokens').textContent = data.usage.total_tokens || 0;
            }
            
            return data.choices[0].message.content;
        }

        async function callDeepSeek(apiKey, message) {
            const response = await fetch('https://api.deepseek.com/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: currentModel.id,
                    messages: [{ role: 'user', content: message }]
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'DeepSeek API error');
            }
            
            const data = await response.json();
            if (data.usage) {
                document.getElementById('inputTokens').textContent = data.usage.prompt_tokens || 0;
                document.getElementById('outputTokens').textContent = data.usage.completion_tokens || 0;
                document.getElementById('totalTokens').textContent = data.usage.total_tokens || 0;
            }
            
            return data.choices[0].message.content;
        }

        async function callSambaNova(apiKey, message) {
            const response = await fetch('https://api.sambanova.ai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: currentModel.id,
                    messages: [{ role: 'user', content: message }]
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'SambaNova API error');
            }
            
            const data = await response.json();
            if (data.usage) {
                document.getElementById('inputTokens').textContent = data.usage.prompt_tokens || 0;
                document.getElementById('outputTokens').textContent = data.usage.completion_tokens || 0;
                document.getElementById('totalTokens').textContent = data.usage.total_tokens || 0;
            }
            
            return data.choices[0].message.content;
        }

        async function callAI21(apiKey, message) {
            const response = await fetch('https://api.ai21.com/studio/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: currentModel.id,
                    messages: [{ role: 'user', content: message }]
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'AI21 API error');
            }
            
            const data = await response.json();
            // AI21 might have different response structure
            return data.choices[0].message.content || data.completions[0].data.text;
        }

        async function callCloudflare(apiKey, message) {
            // Buat input field untuk modal
            const inputId = 'cfAccountId_' + Date.now();
            
            const confirmed = await showModal({
                title: 'üîß Cloudflare Account ID',
                message: `Masukkan <strong>Account ID</strong> Cloudflare Anda:<br><br><input type="text" id="${inputId}" placeholder="xxxxxxxxxxxxxxxxxxxxxxxx" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:8px;font-size:1em;box-sizing:border-box;">`,
                type: 'info',
                icon: 'üîß',
                confirmText: 'Lanjutkan',
                cancelText: 'Batal'
            });
            
            if (!confirmed) {
                throw new Error('Dibatalkan oleh user');
            }
            
            // Get value dari input (delay sedikit untuk DOM update)
            await new Promise(r => setTimeout(r, 100));
            const inputEl = document.getElementById(inputId);
            const accountId = inputEl ? inputEl.value.trim() : '';
            
            if (!accountId) {
                throw new Error('Account ID tidak boleh kosong');
            }
            
            const response = await fetch(`https://api.cloudflare.com/client/v4/accounts/${accountId}/ai/run/${currentModel.id}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    messages: [{ role: 'user', content: message }]
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.errors?.[0]?.message || `Cloudflare error: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error('Cloudflare request tidak berhasil');
            }
            
            return data.result?.response || 'Tidak ada response';
        }

        async function callGitHub(apiKey, message) {
            const response = await fetch('https://models.inference.ai.azure.com/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: currentModel.id,
                    messages: [{ role: 'user', content: message }]
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'GitHub Models API error');
            }
            
            const data = await response.json();
            if (data.usage) {
                document.getElementById('inputTokens').textContent = data.usage.prompt_tokens || 0;
                document.getElementById('outputTokens').textContent = data.usage.completion_tokens || 0;
                document.getElementById('totalTokens').textContent = data.usage.total_tokens || 0;
            }
            
            return data.choices[0].message.content;
        }

        async function callTogether(apiKey, message) {
            const response = await fetch('https://api.together.xyz/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: currentModel.id,
                    messages: [{ role: 'user', content: message }]
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Together AI error');
            }
            
            const data = await response.json();
            if (data.usage) {
                document.getElementById('inputTokens').textContent = data.usage.prompt_tokens || 0;
                document.getElementById('outputTokens').textContent = data.usage.completion_tokens || 0;
                document.getElementById('totalTokens').textContent = data.usage.total_tokens || 0;
            }
            
            return data.choices[0].message.content;
        }

        async function callFireworks(apiKey, message) {
            const response = await fetch('https://api.fireworks.ai/inference/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: currentModel.id,
                    messages: [{ role: 'user', content: message }]
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Fireworks AI error');
            }
            
            const data = await response.json();
            if (data.usage) {
                document.getElementById('inputTokens').textContent = data.usage.prompt_tokens || 0;
                document.getElementById('outputTokens').textContent = data.usage.completion_tokens || 0;
                document.getElementById('totalTokens').textContent = data.usage.total_tokens || 0;
            }
            
            return data.choices[0].message.content;
        }

        async function callPerplexity(apiKey, message) {
            const response = await fetch('https://api.perplexity.ai/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: currentModel.id,
                    messages: [{ role: 'user', content: message }]
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Perplexity error');
            }
            
            const data = await response.json();
            if (data.usage) {
                document.getElementById('inputTokens').textContent = data.usage.prompt_tokens || 0;
                document.getElementById('outputTokens').textContent = data.usage.completion_tokens || 0;
                document.getElementById('totalTokens').textContent = data.usage.total_tokens || 0;
            }
            
            return data.choices[0].message.content;
        }

        async function callHuggingFace(apiKey, message) {
            const response = await fetch(`https://api-inference.huggingface.co/models/${currentModel.id}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    inputs: message,
                    parameters: { max_new_tokens: 1024, return_full_text: false }
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Hugging Face error');
            }
            
            const data = await response.json();
            
            // Hugging Face format berbeda
            if (Array.isArray(data) && data[0]?.generated_text) {
                return data[0].generated_text;
            }
            
            return JSON.stringify(data);
        }

        async function callSiliconFlow(apiKey, message) {
            const response = await fetch('https://api.siliconflow.cn/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: currentModel.id,
                    messages: [{ role: 'user', content: message }]
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'SiliconFlow error');
            }
            
            const data = await response.json();
            if (data.usage) {
                document.getElementById('inputTokens').textContent = data.usage.prompt_tokens || 0;
                document.getElementById('outputTokens').textContent = data.usage.completion_tokens || 0;
                document.getElementById('totalTokens').textContent = data.usage.total_tokens || 0;
            }
            
            return data.choices[0].message.content;
        }

        async function callReplicate(apiKey, message) {
            // Replicate menggunakan format prediction
            const response = await fetch('https://api.replicate.com/v1/models/meta/meta-llama-3-70b-instruct/predictions', {
                method: 'POST',
                headers: {
                    'Authorization': `Token ${apiKey}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'wait'
                },
                body: JSON.stringify({
                    input: { prompt: message }
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Replicate error');
            }
            
            const data = await response.json();
            
            // Poll untuk hasil jika tidak prefer wait
            if (data.status === 'succeeded') {
                return Array.isArray(data.output) ? data.output.join('') : data.output;
            }
            
            return 'Processing... (Replicate async)';
        }

        async function callRouteway(apiKey, message) {
            const response = await fetch('https://api.routeway.ai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: currentModel.id,
                    messages: [{ role: 'user', content: message }]
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Routeway error');
            }
            
            const data = await response.json();
            if (data.usage) {
                document.getElementById('inputTokens').textContent = data.usage.prompt_tokens || 0;
                document.getElementById('outputTokens').textContent = data.usage.completion_tokens || 0;
                document.getElementById('totalTokens').textContent = data.usage.total_tokens || 0;
            }
            
            return data.choices[0].message.content;
        }

        function displayResponse(text, duration) {
            const responseArea = document.getElementById('responseArea');
            const responseTime = document.getElementById('responseTime');
            
            if (!responseArea) return;
            
            responseArea.textContent = text;
            if (responseTime) responseTime.textContent = `${duration}s`;
            
            // AKTIFKAN audio controls
            const audioControls = document.getElementById('audioControls');
            if (audioControls && text && text.length > 10) {
                audioControls.classList.add('active');
                
                // Reset status
                updateAudioStatus('Siap');
                updateProgress(0);
                updatePlayButton(false);
            }
            
            // Calculate output cost
            const outputTokens = parseInt(document.getElementById('outputTokens')?.textContent) || 0;
            const outputCost = (outputTokens / 1000000) * (currentModel?.outputPrice || 0);
            const inputCost = parseFloat(document.getElementById('estCost')?.textContent?.replace('$', '') || 0);
            const totalCost = inputCost + outputCost;
            
            const estCost = document.getElementById('estCost');
            if (estCost) estCost.textContent = '$' + totalCost.toFixed(6);
        }

        function addToHistory(input, output, duration) {
            const inputTokens = parseInt(document.getElementById('inputTokens').textContent) || 0;
            const outputTokens = parseInt(document.getElementById('outputTokens').textContent) || 0;
            
            const historyItem = {
                timestamp: new Date().toLocaleString('id-ID'),
                provider: currentProvider,
                model: currentModel.name,
                modelId: currentModel.id,
                statsKey: `${currentProvider}_${currentModel.id}`,
                // ‚≠ê SIMPAN FULL TEXT untuk restore nanti
                inputFull: input,
                outputFull: output,
                // Preview untuk tampilan di list (bisa diklik untuk expand)
                input: input.substring(0, 60) + (input.length > 60 ? '...' : ''),
                output: output.substring(0, 60) + (output.length > 60 ? '...' : ''),
                duration: duration,
                inputTokens: inputTokens,
                outputTokens: outputTokens,
                tokens: inputTokens + outputTokens,
                cost: ((inputTokens / 1000000) * currentModel.inputPrice) + ((outputTokens / 1000000) * currentModel.outputPrice)
            };
            
            requestHistory.unshift(historyItem);
            if (requestHistory.length > 10) requestHistory.pop();
            
            localStorage.setItem('aiTestHistory', JSON.stringify(requestHistory));
            loadHistory();
        }

        function loadHistory() {
            const historyList = document.getElementById('historyList');
            
            if (requestHistory.length === 0) {
                historyList.innerHTML = '<p style="color: #999; font-size: 0.75em; text-align: center; padding: 20px 0;">Belum ada riwayat</p>';
                return;
            }
            
            historyList.innerHTML = requestHistory.map((item, index) => {
                // Cek apakah punya full text (data baru) atau tidak (data lama)
                const hasFullText = item.inputFull && item.outputFull;
                const indicator = hasFullText ? 'üíæ' : '‚ö†Ô∏è';
                const titleText = hasFullText ? 'Klik untuk restore lengkap' : 'Klik untuk restore (preview only)';
                
                return `
                <div class="history-item" onclick="loadHistoryItem(${index})" title="${titleText}" style="cursor: pointer; ${hasFullText ? 'border-left-color: #4caf50;' : 'border-left-color: #ff9800; opacity: 0.8;'}">
                    <div class="history-timestamp" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>${item.timestamp}</span>
                        <span style="font-size: 1em;">${indicator}</span>
                    </div>
                    <div style="font-size: 0.75em; color: #666; margin-bottom: 3px;">
                        ${item.provider} ‚Ä¢ ${item.model} ‚Ä¢ ${item.duration}s ‚Ä¢ ${item.tokens} tokens
                    </div>
                    <div class="history-preview" style="font-size: 0.8em;">
                        <strong>Input:</strong> ${item.input}
                    </div>
                    ${item.cost ? `<div style="font-size: 0.75em; color: #4caf50; margin-top: 3px;">$${item.cost.toFixed(4)}</div>` : ''}
                </div>
            `}).join('');
        }

        function loadHistoryItem(index) {
            const item = requestHistory[index];
            if (!item) return;
            
            // Switch ke provider & model dari history
            if (item.provider && modelConfigs[item.provider]) {
                const providerSelect = document.getElementById('providerSelect');
                if (providerSelect) providerSelect.value = item.provider;
                
                currentProvider = item.provider;
                populateModels();
                
                // Select model
                const modelSelect = document.getElementById('modelSelect');
                if (modelSelect && item.modelId) {
                    modelSelect.value = item.modelId;
                }
                
                updateModelInfo();
                
                // Load stats untuk model ini
                if (item.statsKey && modelStats[item.statsKey]) {
                    currentSessionStats = { ...modelStats[item.statsKey] };
                    updateStatsDisplay();
                }
            }
            
            // ‚≠ê RESTORE FULL TEXT ke input dan output box
            const chatInput = document.getElementById('chatInput');
            const responseArea = document.getElementById('responseArea');
            const responseTime = document.getElementById('responseTime');
            
            if (chatInput) {
                // Prioritaskan inputFull (data baru), fallback ke input (data lama)
                const fullInput = item.inputFull || item.input || '';
                chatInput.value = fullInput;
                updateTokenCount();
            }
            
            if (responseArea) {
                // Prioritaskan outputFull (data baru), fallback ke output (data lama)
                const fullOutput = item.outputFull || item.output || '';
                responseArea.textContent = fullOutput;
            }
            
            if (responseTime) {
                responseTime.textContent = `${item.duration}s`;
            }
            
            // Update token display dari history yang tersimpan
            const inputTok = item.inputTokens || Math.ceil((item.inputFull || item.input || '').length / 3.5);
            const outputTok = item.outputTokens || Math.ceil((item.outputFull || item.output || '').length / 3.5);
            
            document.getElementById('inputTokens').textContent = inputTok.toLocaleString();
            document.getElementById('outputTokens').textContent = outputTok.toLocaleString();
            document.getElementById('totalTokens').textContent = (inputTok + outputTok).toLocaleString();
            
            // Update cost juga
            if (item.cost) {
                document.getElementById('estCost').textContent = '$' + item.cost.toFixed(4);
            }
            
            showSuccess(`Restored: ${item.provider} - ${item.model} (${item.tokens} tokens)`);
        }

        // Migration: Convert old history format to new format (optional)
        function migrateHistory() {
            let migrated = false;
            requestHistory = requestHistory.map(item => {
                if (!item.inputFull && item.input) {
                    item.inputFull = item.input;
                    migrated = true;
                }
                if (!item.outputFull && item.output) {
                    item.outputFull = item.output;
                    migrated = true;
                }
                return item;
            });
            
            if (migrated) {
                localStorage.setItem('aiTestHistory', JSON.stringify(requestHistory));
                console.log('History migrated to new format');
            }
        }

        // Panggil saat init
        document.addEventListener('DOMContentLoaded', () => {
            migrateHistory();
            // ... rest of init code
        });

        // 1. Clear Chat Only - hapus input dan output saja, stats tetap tersimpan
        function clearChatOnly() {
            // Stop audio
            stopSpeech();
            
            // Hide audio controls
            const audioControls = document.getElementById('audioControls');
            if (audioControls) audioControls.classList.remove('active');

            // Stop voice jika sedang recording
            if (isRecording) {
                stopVoiceInput();
            }
            
            // Clear audio Whisper
            uploadedAudio = null;
            updateAudioUI();
            
            document.getElementById('chatInput').value = '';
            document.getElementById('responseArea').innerHTML = '<span style="color: #999; font-style: italic;">Jawaban akan muncul di sini...</span>';
            document.getElementById('inputTokenCount').textContent = '0';
            document.getElementById('tokenBar').style.width = '0%';
            document.getElementById('tokenBar').textContent = '0%';
            document.getElementById('responseTime').textContent = '';
            
            // Clear uploaded files juga
            clearAllUploadedFiles();
            
            showSuccess('Chat dibersihkan');
        }

        // 2. Clear History Only - hapus riwayat request
        async function clearHistoryOnly() {
            const confirmed = await showModal({
                title: 'üìú Hapus Riwayat',
                message: 'Apakah Anda yakin ingin menghapus <strong>semua riwayat chat</strong>?<br><br>Data yang dihapus tidak bisa dikembalikan.',
                type: 'danger',
                icon: 'üóëÔ∏è',
                confirmText: 'Ya, Hapus',
                cancelText: 'Batal'
            });
            
            if (confirmed) {
                requestHistory = [];
                localStorage.removeItem('aiTestHistory');
                loadHistory();
                showSuccess('Riwayat berhasil dibersihkan', 'üóëÔ∏è Terhapus');
            }
        }

        // 3. Clear Stats Only - reset statistik per model
        async function clearStatsOnly() {
            if (!currentProvider || !currentModel) {
                showError('Pilih model terlebih dahulu');
                return;
            }
            
            const modelName = currentModel.name;
            const statsKey = `${currentProvider}_${currentModel.id}`;
            const stats = modelStats[statsKey];
            
            let statsInfo = '';
            if (stats) {
                statsInfo = `<br><br><strong>Statistik saat ini:</strong><ul>
                    <li>${stats.inputTokens.toLocaleString()} input tokens</li>
                    <li>${stats.outputTokens.toLocaleString()} output tokens</li>
                    <li>${stats.requestCount} requests</li>
                    <li>$${stats.totalCost.toFixed(4)} total biaya</li>
                </ul>`;
            }
            
            const confirmed = await showModal({
                title: 'üìä Reset Statistik',
                message: `Reset statistik untuk <strong>${modelName}</strong>?${statsInfo}`,
                type: 'warning',
                icon: 'üìä',
                confirmText: 'Ya, Reset',
                cancelText: 'Batal'
            });
            
            if (confirmed) {
                delete modelStats[statsKey];
                localStorage.setItem('aiModelStats', JSON.stringify(modelStats));
                
                currentSessionStats = { inputTokens: 0, outputTokens: 0, requestCount: 0, totalCost: 0 };
                updateStatsDisplay();
                
                showSuccess(`Statistik ${modelName} direset`, 'üìä Direset');
            }
        }

        // 4. Clear All Data - hapus semua (chat, history, stats semua model)
        async function clearAllData() {
            // Step 1: Confirm clear all
            const confirm1 = await showModal({
                title: '‚ö†Ô∏è Hapus SEMUA Data',
                message: 'Anda akan menghapus:<br><ul><li>üí¨ Chat saat ini</li><li>üìú Semua riwayat (10 terakhir)</li><li>üìä Statistik <strong>semua model</strong></li></ul>Data akan hilang permanen!',
                type: 'danger',
                icon: '‚ö†Ô∏è',
                confirmText: 'Lanjutkan ‚Üí',
                cancelText: 'Batal'
            });
            
            if (!confirm1) return;
            
            // Step 2: Confirm API keys
            const confirm2 = await showModal({
                title: 'üîë API Keys',
                message: 'Apakah juga ingin menghapus <strong>API Keys</strong> yang tersimpan?<br><br>Anda harus memasukkan ulang nanti.',
                type: 'warning',
                icon: 'üîë',
                confirmText: 'Ya, Hapus Juga',
                cancelText: 'Tidak, Simpan Keys'
            });
            
            // Execute clear
            clearChatOnly();
            
            requestHistory = [];
            localStorage.removeItem('aiTestHistory');
            
            modelStats = {};
            localStorage.removeItem('aiModelStats');
            currentSessionStats = { inputTokens: 0, outputTokens: 0, requestCount: 0, totalCost: 0 };
            updateStatsDisplay();
            
            if (confirm2) {
                Object.keys(modelConfigs).forEach(provider => {
                    localStorage.removeItem(`apiKey_${provider}`);
                });
                const apiKeyInput = document.getElementById('apiKey');
                if (apiKeyInput) apiKeyInput.value = '';
                showSuccess('Semua data & API Keys dihapus', 'üóëÔ∏è Semua Terhapus');
            } else {
                showSuccess('Semua data dihapus (kecuali API Keys)', 'üóëÔ∏è Data Terhapus');
            }
            
            loadHistory();
        }

        // Legacy function untuk backward compatibility (jika ada yang manggil clearChat lama)
        function clearChat() {
            clearChatOnly();
        }

        function loadTestText() {
            const testTexts = [
                "Jelaskan secara detail tentang kecerdasan buatan dan dampaknya pada masyarakat modern, termasuk aspek etika, ekonomi, dan teknologi.",
                "Tulis sebuah esai panjang (minimal 500 kata) tentang sejarah perkembangan komputer dari era vacuum tube hingga quantum computing.",
                "Analisis perbandingan mendalam antara berbagai arsitektur neural network: CNN, RNN, LSTM, Transformer, dan Vision Transformer.",
                "Buatkan kode Python lengkap untuk implementasi algoritma machine learning dari scratch tanpa menggunakan library scikit-learn."
            ];
            
            const randomText = testTexts[Math.floor(Math.random() * testTexts.length)];
            document.getElementById('chatInput').value = randomText;
            updateTokenCount();
        }

        // Safety net - handle errors gracefully
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Global error:', msg, 'at line:', lineNo);
            if (msg.includes('Cannot read properties of undefined')) {
                console.log('Attempting recovery...');
                currentProvider = 'gemini';
                populateModels();
            }
            return false;
        };

        // Toast Notification System
        function showToast(message, type = 'info', title = null, duration = 5000) {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            
            const titles = {
                success: 'Sukses',
                error: 'Error',
                warning: 'Peringatan',
                info: 'Info'
            };
            
            const toastTitle = title || titles[type] || titles.info;
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            // HAPUS icon, hanya judul + pesan + tombol close
            toast.innerHTML = `
                <div class="toast-content" style="margin-left: 0;">
                    <div class="toast-title">${toastTitle}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
                <div class="toast-progress">
                    <div class="toast-progress-bar"></div>
                </div>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.animation = 'fadeOut 0.3s ease forwards';
                    setTimeout(() => toast.remove(), 300);
                }
            }, duration);
            
            while (container.children.length > 5) {
                container.firstChild.remove();
            }
        }

        // Modal/Confirmation System
        let modalResolve = null;

        function showModal(options) {
            return new Promise((resolve) => {
                modalResolve = resolve;
                
                const overlay = document.getElementById('modalOverlay');
                const icon = document.getElementById('modalIcon');
                const title = document.getElementById('modalTitle');
                const body = document.getElementById('modalBody');
                const footer = document.getElementById('modalFooter');
                
                // Set content
                icon.textContent = options.icon || '‚ö†Ô∏è';
                icon.className = `modal-icon ${options.type || 'warning'}`;
                title.textContent = options.title || 'Konfirmasi';
                body.innerHTML = options.message || 'Apakah Anda yakin?';
                
                // Build buttons
                let buttonsHTML = '';
                
                if (options.showCancel !== false) {
                    const cancelText = options.cancelText || 'Batal';
                    buttonsHTML += `<button class="modal-btn modal-btn-secondary" onclick="closeModal(false)">${cancelText}</button>`;
                }
                
                const confirmText = options.confirmText || 'Ya, Lanjutkan';
                const btnClass = options.type === 'danger' ? 'modal-btn-danger' : 
                                options.type === 'primary' ? 'modal-btn-primary' : 'modal-btn-danger';
                
                buttonsHTML += `<button class="modal-btn ${btnClass}" onclick="closeModal(true)">${confirmText}</button>`;
                
                footer.innerHTML = buttonsHTML;
                
                // Show modal
                overlay.classList.add('active');
                
                // Close on overlay click
                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        closeModal(false);
                    }
                };
                
                // Close on Escape key
                document.addEventListener('keydown', handleEscape);
            });
        }

        function closeModal(result) {
            const overlay = document.getElementById('modalOverlay');
            overlay.classList.remove('active');
            
            document.removeEventListener('keydown', handleEscape);
            
            if (modalResolve) {
                modalResolve(result);
                modalResolve = null;
            }
        }

        function handleEscape(e) {
            if (e.key === 'Escape') {
                closeModal(false);
            }
        }

        // Legacy confirm replacement
        function showConfirm(message, title = 'Konfirmasi', type = 'warning') {
            return showModal({
                title: title,
                message: message,
                type: type,
                icon: type === 'danger' ? 'üóëÔ∏è' : type === 'warning' ? '‚ö†Ô∏è' : '‚ùì',
                confirmText: 'Ya',
                cancelText: 'Tidak'
            });
        }

        // Legacy functions for backward compatibility
        function showError(message, title = null) {
            showToast(message, 'error', title || '‚ùå Error');
        }

        function showSuccess(message, title = null) {
            showToast(message, 'success', title || '‚úÖ Sukses');
        }

        function showWarning(message, title = null) {
            showToast(message, 'warning', title || '‚ö†Ô∏è Peringatan');
        }

        function showInfo(message, title = null) {
            showToast(message, 'info', title || '‚ÑπÔ∏è Info');
        }
    </script>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    <!-- Modal Confirmation -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-icon" id="modalIcon">‚ö†Ô∏è</div>
                <h3 class="modal-title" id="modalTitle">Konfirmasi</h3>
            </div>
            <div class="modal-body" id="modalBody">
                Apakah Anda yakin?
            </div>
            <div class="modal-footer" id="modalFooter">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal(false)">Batal</button>
                <button class="modal-btn modal-btn-danger" onclick="closeModal(true)">Ya, Lanjutkan</button>
            </div>
        </div>
    </div>
</body>
</html>